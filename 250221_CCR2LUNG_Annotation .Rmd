---
title: "250108 tSNE and annotation relative"
author: "Xiaofei YU"
date: "2025-01-08"
output: 
html_document:
    theme:
      spacelab
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
    number_sections: false
    highlight: textmate 
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(gplots)
library(pheatmap)
library(Rtsne)
library(ggplot2)
library(dplyr)
library(RColorBrewer)
library(stringr)
library(gridExtra)
library(RColorBrewer)
library(ggridges)
library(ggpubr)
library(scales)
library(clustree)
library(cowplot)
library(umap)
library(rlang)
```

#load data
```{r global-variables, include=TRUE, results=FALSE}
# Path for loading data and saving results 
# Project folder path:
BASE = "/mnt/Data1/groupfebe/runs/Xiaofei/CCR2_LUNG"

# Name of input and output directories:
INPUT_PATH = file.path(BASE, "Data/Annotation_input")
OUTPUT_PATH = file.path(BASE, "Results/Annotation_output/")

# Load celldata excluding tSNE coordinates  /load sampled celldata with tSNE coordinates. 
celldata = read.csv(paste0(INPUT_PATH, "/250218_normalised_concatenated_scaled_data_001threshold.csv"))
#celldata_subsample = read.csv(paste0(INPUT_PATH,"/250107_celldata_subsamples.csv"))

# Add clustering and t-SNE columns to datafiles
# tSNEcsv is sampledtSNE 
tSNECSV = read.csv(file.path(INPUT_PATH, "250218_tSNE.csv"))
clustCSV = read.csv(file.path(INPUT_PATH, "250218_clustering_k30_k25_k20_k15_19markers.csv"))
celldata = cbind(celldata, clustCSV)
# Load in the image metadata
imagemetadata = read.csv(file.path(INPUT_PATH, "imagemetadata.csv"))
# Due to the computer is not powerful enough ,so I only get sampled tSNE here. celldata_subsample is using for making plots which includes tSNE coordinates.
#celldata_subsample = cbind(celldata_subsample, tSNECSV)
celldata = cbind(celldata, tSNECSV)
##celldata with part tSNE coordinates "NA" but i dont need using tSNE coordinate for heatmap
# columns_to_add <- c("cell_ID","tSNE1", "tSNE2")
# celldata <- left_join(x = celldata, y = celldata_subsample[,columns_to_add], 
#                      by = "cell_ID")

celldata <- celldata %>%
  mutate(name = paste(ROI_ID, filename, sep = "_"))
unique(celldata$name)


create.resultsdir <- function(path, name) {
  dir_path <- file.path(path, name)
  if (!dir.exists(dir_path)) {
    dir.create(dir_path, recursive = TRUE)
    message("Directory created: ", dir_path)
  } else {
    message("Directory already exists: ", dir_path)
  }
  return(dir_path)
}

date = str_sub(gsub("-", "", Sys.Date()), -6, -1)
# Load in UMAP dataframes-- need to make umap after annotation [cycle]
#TCD = read.csv(file.path(INPUT_PATH, "TCD.csv"))
#MacDendCD = read.csv(file.path(INPUT_PATH, "MacDendCD.csv"))
#FibEndoCD = read.csv(file.path(INPUT_PATH, "FibEndoCD.csv"))
#MyeloidCD = read.csv(file.path(INPUT_PATH, "MyeloidCD.csv"))
```
###########   Reload data, not from begainning  (minues annotation .exp.)
```{r}
# Project folder path:
BASE = "/mnt/Data1/groupfebe/runs/Xiaofei/240920_Sahai_CCR2_IMC"

# Name of input and output directories:
INPUT_PATH = file.path(BASE, "Projectfile/Data/Figures_input")
OUTPUT_PATH = file.path(BASE, "Projectfile/Results/Figures_output/")
#input celldata 
celldata = read.csv(paste0(INPUT_PATH, "/241202_celldata.csv"))
CellCD = read.csv(paste0(OUTPUT_PATH, "/250218CellCD.csv"))
TCD = read.csv(paste0(OUTPUT_PATH, "/250218TCD.csv"))
TumourFibEndoEpiCD =read.csv(paste0(OUTPUT_PATH, "/250218TumourFibEndoEpiCD.csv"))
MacDendNeuMonoCD=read.csv(paste0(OUTPUT_PATH, "/250218MacDendNeuMonoCD.csv"))
MacCD =read.csv(paste0(OUTPUT_PATH, "/241101MacCD.csv"))
MacDendCD =read.csv(paste0(OUTPUT_PATH, "/241101MacDendCD.csv"))
FibEndoCD =read.csv(paste0(OUTPUT_PATH, "/241101FibEndoCD.csv"))
MacFibTumNeuCD =read.csv(paste0(OUTPUT_PATH, "/241101MacDendFibTumNeuCD.csv"))
stat_241105_ROI = read.csv(paste0(OUTPUT_PATH, "/_stat_241105_ROI.csv"))
imagemetadata = read.csv(file.path(OUTPUT_PATH, "imagemetadata.csv"))

```



#set function for plot tSNE and heatmap
```{r global-variables, include=TRUE, results=FALSE}
# Make heatmap matrix-----------------------------------------------------------
# Description : Create a heatmap matrix that contains mean expression data per
#               marker per level of the given factor. Rows in this matrix are
#               markers in 'markerlist', columns are levels in 'factor'.
# ---Parameters---
# celldata    --> [dataframe] a dataframe with marker intensity data.
# markerlist  --> [vector] a vector with names of columns of celldata with
#                 marker expression data that should be included in the heatmap.
# factor      --> [string] the name of a column of celldata that acts as a factor.
# << Output >>    [image] A dataframe with the mean marker expression for each
#                 marker in markerlist for all the levels in factor.

##  get cluster center from clusting results
get.cluster.centers = function(celldata, tSNEaxes, clustering){
  celldata = celldata[!is.na(celldata[,clustering]),]
  clusterCenters = data.frame()
  for (cl in unique(celldata[,clustering])){
    x = median(celldata[,tSNEaxes[1]][which(celldata[,clustering] == cl)])
    y = median(celldata[,tSNEaxes[2]][which(celldata[,clustering] == cl)])
    clusterCenters[cl, "cl"] = cl
    clusterCenters[cl, "x"] = x
    clusterCenters[cl, "y"] = y
  }
  return(clusterCenters)
}



make.heatmap.matrix = function(celldata, markerlist, cluster){
  heatmap_df = data.frame()
  
  # Leave out unclustered cells (cluster == NA)
  celldata = celldata[!is.na(celldata[,cluster]),]

  for (cl in unique(celldata[,cluster])){
    md = celldata[celldata[,cluster] == cl,]
    for (marker in markerlist){
      heatmap_df[cl, marker] =  mean(md[,paste("MI_", marker, sep = "")])
      heatmap_df[cl, "clustername"] = cl
    }
  }
  
  row.names(heatmap_df) = heatmap_df$clustername
  heatmap_df = t(as.matrix(subset(heatmap_df, select = -clustername)))
  
  return(heatmap_df)
}



plot.heatmap2 = function(celldata, markerlist, cluster, scale="column", title,
                         margins=c(4,5), srtCol=0, Rowv=NULL, Colv=NULL,
                         barplot = c(), type = "stack", transpose = F
){
  matrix = make.heatmap.matrix(celldata, markerlist, cluster)
  
  if (transpose) {matrix = t(matrix)}
  
  hm = heatmap.2(matrix,
                 dendrogram = "none", Rowv = Rowv, Colv = Colv, 
                 scale = scale, trace = "none", 
                 #col = colorRampPalette(brewer.pal(8, "Blues"))(25),
                col = colorRampPalette(c("blue","white","red"))(25),
                 
                 main = title, margins = margins,
                 cexRow = 1, cexCol = 1, srtCol = srtCol,
                 keysize = .8, density.info = "none", key.par=list(mar = c(4,0.5,2,0.7)),
                 lmat = matrix(data = c(0,0,0,4,1,1,3,1,1,2,2,2), ncol = 4),
                 lwid = c(.5, 1.8, 6.5, 0.01), lhei = c(2, 1.8, 5))
  
  if (length(barplot) != 0) {
    for (i in 1:length(barplot)) {
      df = as.data.frame(table(paste(celldata[!is.na(celldata[,cluster]), cluster],
                                     celldata[,barplot[i]], sep = "x_x")))
      df = cbind(str_split_fixed(df[,1], "x_x", n = 2), df[,2])
      df = data.frame(as.numeric(df[,1]), df[,2], as.numeric(df[,3]))
      colnames(df) = c("cluster", "ROI_ID", "Cell_count")
      df$cluster = factor(df$cluster, levels = hm$colInd)
      
      p = ggplot(df, aes(fill=ROI_ID, y=Cell_count, x=cluster)) + 
        geom_bar(position=type, stat="identity", orientation = "x") +
        ggtitle(paste0("Cell count by ", barplot[i])) + theme_classic() +
        theme(plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
              axis.text.x = element_text(angle = 90, vjust = .5),
              plot.margin = unit(c(0.02, 0, .03, 0), units = "npc"))
      print(p)
    }
  }
}

# Create a scatter plot --------------------------------------------------------
# Description : Plot cells in a scatterplot based on two markers ('Xmarker' and
#               'Ymarker') of which the mean intensity is plotted on the X and Y
#               axis respectively
# ---Parameters---
# celldata  --> [dataframe] a dataframe with mean intensity data by marker
# factor    --> [string] name of a column of 'dataframe' that acts as a factor
# levels    --> [vector] a vector with levels of factor; cells belonging to
#               one of these levels are included in the plot
# Xmarker   --> [string] name of a column with mean intensity data (X-axis)
# Ymarker   --> [string] name of a column with mean intensity data (Y-axis)
# title     --> [string ("")] name of the plot
# axisLim   --> [int (2)] upper limit of the axes
# << Output >>  [string] the path to the second created folder with name 'name'

plot.scatter = function(celldata, cluster, clusterN, Xmarker, Ymarker,
                        main = "", dim = 2, layout = "ghostvar") {
  # Select celldata of the selected clusters
  celldata = celldata[celldata[,cluster] %in% clusterN,]
  
  # Convert the markers into symbols to be used by ggplot
  x = sym(paste0("MI_", Xmarker))
  y = sym(paste0("MI_", Ymarker))
  
  # Set the nbin based on the celldata size
  nbin = ifelse(nrow(celldata)>200000, 1024, 
                ifelse(nrow(celldata)>20000, 512, 256))
  
  # Color by density
  colramp = colorRampPalette(rev(brewer.pal(n = 9, name = "YlGn")[3:9]))
  color = densCols(x = celldata[,paste0("MI_", Xmarker)],
                   y = celldata[,paste0("MI_", Ymarker)],
                   colramp = colramp, nbin = nbin)
  
  ggplot(data = celldata, aes(x = !!x, y = !!y)) +
    geom_point(shape = I(20), size = 1.5, aes(x = !!x, y = !!y, col = color)) +
    scale_x_continuous(limits = c(0,dim), expand = c(0,0),
                       oob = scales::squish) +
    scale_y_continuous(limits = c(0,dim), expand = c(0,0),
                       oob = scales::squish) + scale_color_identity() + 
    ggtitle(main) + ylab(Ymarker) + xlab(Xmarker) + theme_classic() + 
    theme(plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
          plot.margin = unit(c(0.05, 0, .05, 0), units = "npc"),
          axis.title = element_text(size = 8, face = "bold"),
          axis.text = element_text(size = 8, colour = "black"),
          panel.background = element_rect(fill = "grey95"), aspect.ratio = 1)
}

# Create a heated scatter plot -------------------------------------------------
# Description : Plot cells in a scatterplot based on three markers ('Xmarker',
#               'Ymarker' and 'colorMarker') of which the mean intensity of the
#               first two is plotted on the X and Y axis, and the third marker
#               is represented as colourgradient of the plotted datapoints.
# ---Parameters---
# celldata    --> [dataframe] a dataframe with mean intensity data by marker
# factor      --> [string] name of a column of 'dataframe' that acts as a factor
# levels      --> [vector] a vector with levels of factor; cells belonging to
#                 one of these levels are included in the plot
# Xmarker     --> [string] name of a column with mean intensity data (X-axis)
# Ymarker     --> [string] name of a column with mean intensity data (Y-axis)
# colorMarker --> [string] name of a column with mean intensity data (colour)
# title       --> [string: ""] name of the plot
# axisLim     --> [int: 2] upper limit of the axes
# small       --> [boolean: T] if TRUE, a small version of the plot is created
# << Output >>    [string] the path to the second created folder with name 'name'
plot.scatter3 = function(celldata, cluster, clusterN, Xmarker, Ymarker,
                         colorMarker, main = "", dim = 2, layout = "small") {
  # Select celldata of the selected clusters
  celldata = celldata[celldata[,cluster] %in% clusterN,]
  
  # Convert the markers into symbols to be used by ggplot
  x = sym(paste0("MI_", Xmarker))
  y = sym(paste0("MI_", Ymarker))
  
  if(grepl("ROI", colorMarker, fixed = T)) {
    c = sym(colorMarker)
  } else {
    c = sym(paste0("MI_", colorMarker))
  }
  
  # Change the size of the legend based on the layout parameter
  if (layout == "small") {
    keySize = unit(.010, "npc")
    keyPos = c(0.71, 0.90)
    keyMar = margin(t = 0.005,r = 0.005,b = 0.005,l = 0.005, unit = "npc")
    keyTextSize = 3
  } else {
    keySize = unit(.02, "npc")
    keyPos = c(0.75, 0.92)
    keyMar = margin(t = 0.01, r = 0.01, b = 0.01, l = 0.01, "npc")
    keyTextSize = 4
  }
  
  ggplot(data = celldata, aes(x = !!x, y = !!y)) +
    geom_point(shape = I(20), size = 1.5, aes(x = !!x, y = !!y, color = !!c)) +
    scale_color_gradientn(colours = rainbow(5)) + labs(color = colorMarker) +
    scale_x_continuous(limits = c(0,dim), expand = c(0,0),
                       oob = scales::squish) +
    scale_y_continuous(limits = c(0,dim), expand = c(0,0),
                       oob = scales::squish) +
    ggtitle(main) + xlab(Xmarker) + ylab(Ymarker) + theme_classic() +
    
    theme(plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
          plot.margin = unit(c(0.02, 0, .03, 0), units = "npc"),
          axis.title = element_text(size = 8, face = "bold"),
          axis.text = element_text(size = 8, colour = "black"),
          legend.title = element_text(size = 8, face= "bold"),
          legend.key.size = keySize, legend.position.inside =  keyPos,
          legend.margin = keyMar, legend.text = element_text(size = keyTextSize),
          legend.background = element_rect(fill = "grey80"),
          legend.justification = "center", legend.direction = "horizontal",
          panel.background = element_rect(fill = "grey95"), aspect.ratio = 1)
}

```


# using plot.tSNE  :checking the mix for group and ROI
```{r plot tSNE function}

# set colour for tSNE plot 
mycolors = sample(colorRampPalette(brewer.pal(8, "Set1"))(36))
# Plot the generated t-SNE with the current data
plot.tSNE = function(celldata, tSNEaxes, clustering, lvls, title,
                     labelClusters = T, savetSNE = F) {
  if (labelClusters) {
    clusterCenters = get.cluster.centers(celldata, tSNEaxes, clustering)
  }
  
  tSNEx = sym(tSNEaxes[1])
  tSNEy = sym(tSNEaxes[2])
  clustering = sym(clustering)
  
  if (missing(lvls)) {
    lvls = clustering
  }
## sample tSNE   I have alread samping 10,000 for making tSNE .there is still define function?  
  p = ggplot(celldata[sample(nrow(celldata), 20000),]) +
    geom_point(size = 0.1,
               aes(x = !!tSNEx, y= !!tSNEy,
                   colour = factor(!!clustering,
                                   levels = sort(unique(!!lvls))))) +
    scale_color_manual(values = mycolors) +
  
 # Plot the cluster centers
    {if (labelClusters) {
      list(geom_point(data = clusterCenters, size = 6, aes(x=x, y=y),
                      colour = "black", pch = 21, fill = "white",
                      show.legend = F),
           geom_text(data = clusterCenters, stat = "identity", show.legend = F,
              mapping = aes(x = x, y = y, label = cl, size = 12),
              colour = "black", size = 3))}} +
    
    theme_classic() +
    theme(plot.title = element_text(size = 20, hjust = 0.5),
          legend.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.text = element_text(size = 10)) +
    guides(colour = guide_legend(override.aes = list(size=5))) +
    ggtitle(title) 
## savetSNE
  if (savetSNE) {
    date = str_sub(gsub("-", "", Sys.Date()), -6, -1)
    title_name = gsub(pattern = " ", replacement =  "_", x = title)
    filename = paste0(date, "_t-SNE_", title_name, ".jpeg")
    ggsave(
  filename = filename, 
  plot = p, 
  device = "jpeg", 
  bg = "white",
  width = 2500, 
  height = 1700, 
  dpi = 300, 
  units = "px",
  path = paste0(OUTPUT_PATH, "/tSNE")
)
  }
  
  return(p)
}
```

## Plot other tSNE
```{r}
### According to the requirement , decide save TSNE as F or T 
plot.tSNE(celldata, c("tSNE1", "tSNE2"), "ExpGroup",
          title = "Experimental model", labelClusters = F, savetSNE = T)
plot.tSNE(celldata, c("tSNE1", "tSNE2"), "ROI_ID", savetSNE = T,
          title = "ROI ID", labelClusters = F)


plottingtSNE = function(model) {
  levels = grep(pattern = model, x = unique(celldata$ROI_ID), value = T)
  p = plot.tSNE(celldata, c("tSNE1", "tSNE2"), "ROI_ID", lvls = levels,
          title = paste0(model, "_ROIs"), labelClusters = F, savetSNE = T)
  return(list(p))
}

exp_models = c("WT","CCR2KO")

sapply(X = exp_models, FUN = plottingtSNE)

```

# Heatmap
Generate a heatmap with markers versus clusters.
```{r}
#explanition of plotheatmap
# Plot heatmap -----------------------------------------------------------------
# Description : Create a heatmap matrix that contains mean expression data per
#               marker per level of the given factor. Rows in this matrix are
#               markers in 'markerlist', columns are levels in 'factor'. If 
# ---Parameters---
# celldata    --> [dataframe] a dataframe with marker intensity data.
# markerlist  --> [vector] a vector with names of columns of celldata with
#                 marker expression data that should be included in the heatmap.
# factor      --> [string] the name of a column of celldata that acts as a factor.
# title       --> [string] the title of the plot
# transpose   --> [boolean F] if T, columns and rows are interchanged
# scale       --> [string "column"] indicates whether the heatmap should be
#                 scaled by row or by column
# Rowv        --> [boolean F] if T, rows are reordered according to a dendrogram
# Colv        --> [boolean F] if T, columns are reordered acc. to a dendrogram
# margins     --> [vector c(4, 5)] a vector lenght 2, representing the size of  the bottom and right margin respectively
# srtCol      --> [int 0] indicates the angle at which the column labels are displayed
# barplot     --> [vector c()] a vector that contains column names of celldata
#                 that act as a factor. For each 'barplot factor', a plot with
#                 stacked barplots for each level of 'factor' is created showing
#                 the distribution of cells within that level over the levels
#                 of the 'barplot factor'. The levels of factor are plotted
#                 over de x axis in the same order as the heatmap.
# saveHM      --> [boolean F] if T the heatmap is automatically saved
# saveBP      --> [boolean F] if T the barplot(s) is/are automatically saved
# << Output >>    [image] A heatmap showing the mean marker expression for each
#                 marker in markerlist for all the levels in factor.
```


#checking annotation with scatter plot
```{r}
plot.scatter(celldata, "k20", 12, Xmarker = "CD3e", Ymarker = "Foxp3",dim=1.5)
plot.scatter(celldata, "k20", 21, Xmarker = "CD11b", Ymarker = "LY6G",dim=1.5)
plot.scatter(celldata, "k20", 21, Xmarker = "CD45", Ymarker = "LY6G",dim=1.5)
plot.scatter(celldata, "k20", 21, Xmarker = "Ly6C", Ymarker = "LY6G",dim=1.5)
plot.scatter(celldata, "k20", 6, Xmarker = "CD11c", Ymarker = "F480",dim=1)
plot.scatter(celldata, "k20", 6, Xmarker = "CD11c", Ymarker = "CD68",dim=1)
plot.scatter(celldata, "k20", 6, Xmarker = "CD11c", Ymarker = "MHCII",dim=1)
plot.scatter(celldata, "k20", 21, Xmarker = "LY6G", Ymarker = "CD68",dim=1)
plot.scatter(celldata, "k20", 21, Xmarker = "LY6G", Ymarker = "F480",dim=1)
plot.scatter(celldata, "k20", 1, Xmarker = "PDL1", Ymarker = "CD68",dim=1)
plot.scatter(celldata, "k20", 1, Xmarker = "PVR", Ymarker = "CD68",dim=1)
plot.scatter(celldata, "k20", 1, Xmarker = "PVR", Ymarker = "F480",dim=1)
plot.scatter(celldata, "k20", 9, Xmarker = "CD11c", Ymarker = "F480",dim=1.5)
plot.scatter(celldata, "k20", 9, Xmarker = "CD68", Ymarker = "CD11c",dim=1.7)
plot.scatter(celldata, "k20", 4, Xmarker = "F480", Ymarker = "CD44",dim=0.7)
plot.scatter(celldata, "k20", 4, Xmarker = "CD11c", Ymarker = "CD44",dim=1.5)
plot.scatter(celldata, "k20", 4, Xmarker = "CD11c", Ymarker = "F480",dim=1)
plot.scatter(celldata, "k20", 4, Xmarker = "CD11c", Ymarker = "CD68",dim=1)
plot.scatter(celldata, "k20", 4, Xmarker = "CD11c", Ymarker = "CD206",dim=1.5)
plot.scatter(celldata, "k20", 4, Xmarker = "CD11c", Ymarker = "MHCII",dim=1)
plot.scatter(celldata, "k20", 4, Xmarker = "MHCcII", Ymarker = "CD44",dim=1.5)
plot.scatter(celldata[celldata$ROI_ID=="01_MOC2_CCR2KO",], "k20", 3, Xmarker = "CD206", Ymarker = "aSMA",dim=1.5)
plot.scatter(celldata[celldata$ROI_ID=="05_MOC2_CCR2KO",], "k20", 3, Xmarker = "CD206", Ymarker = "aSMA",dim=1.5)
plot.scatter(celldata[celldata$ROI_ID=="03_MOC2_CCR2KO",], "k20", 3, Xmarker = "CD206", Ymarker = "aSMA",dim=1.5)
plot.scatter(celldata[celldata$ROI_ID=="06_MOC2_CCR2KO",], "k20", 3, Xmarker = "CD206", Ymarker = "aSMA",dim=1.5)
plot.scatter(celldata, "k20", 3, Xmarker = "aSMA", Ymarker = "CD206",dim=1.5)
plot.scatter(celldata, "k20", 4, Xmarker = "CD11c", Ymarker = "CD11b",dim=0.4)
plot.scatter(celldata, "k20", 4, Xmarker = "CD11b", Ymarker = "CD44",dim=0.5)
plot.scatter(celldata, "k20", 4, Xmarker = "LY6G", Ymarker = "CD11b",dim=0.5)
plot.scatter3(celldata, "k20", 4, Xmarker = "CD44", Ymarker = "CD11c","MHCcII",dim=2)
plot.scatter3(celldata, "k20", 4, Xmarker = "CD11c", Ymarker = "F480","MHCcII",dim=1)
plot.scatter(celldata, "k20", 7, Xmarker = "CD68", Ymarker = "F480",dim=1)
plot.scatter(celldata, "k20", 7, Xmarker = "CD68", Ymarker = "pS6",dim=0.7)
plot.scatter(celldata, "k20", 7, Xmarker = "CD68", Ymarker = "CD44",dim=0.7)
plot.scatter(celldata, "k20", 7, Xmarker = "CD68", Ymarker = "PVR",dim=0.7)
plot.scatter(celldata, "k20", 7, Xmarker = "CD11b", Ymarker = "CD11c",dim=1)
plot.scatter(celldata, "k20", 9, Xmarker = "aSMA", Ymarker = "CD44",dim=1)
plot.scatter(celldata, "k20", 10, Xmarker = "F480", Ymarker = "CD68",dim=1)
plot.scatter(celldata, "k20", 17, Xmarker = "CD11c", Ymarker = "CD44",dim=1.5)
plot.scatter(celldata, "k20", 17, Xmarker = "MHCcII", Ymarker = "CD44",dim=1.5)
plot.scatter(celldata, "k20", 17, Xmarker = "CD11c", Ymarker = "PVR",dim=1)
plot.scatter(celldata, "k20", 17, Xmarker = "CD11c", Ymarker = "pS6",dim=1)
plot.scatter(celldata, "k20", 17, Xmarker = "CD11c", Ymarker = "PDL1",dim=1)
plot.scatter(celldata, "k20", 21, Xmarker = "CD103", Ymarker = "MHCII",dim=1)
plot.scatter(celldata[celldata$ROI_ID=="08_MOC2_WT",], "k20", 17, Xmarker = "MHCcII", Ymarker = "CD11c",dim=2)
plot.scatter(celldata[celldata$ROI_ID=="09_MOC2_WT",], "k20", 17, Xmarker = "MHCcII", Ymarker = "CD11c",dim=2)
plot.scatter(celldata[celldata$ROI_ID=="10_MOC2_WT",], "k20", 17, Xmarker = "MHCcII", Ymarker = "CD11c",dim=2)
plot.scatter(celldata[celldata$ROI_ID!="07_MOC2_WT",], "k20", 17, Xmarker = "MHCcII", Ymarker = "CD11c",dim=2)
plot.scatter(celldata, "k20", 17, Xmarker = "MHCcII", Ymarker = "CD11c",dim=2)
plot.scatter(celldata, "k20", 18, Xmarker = "F480", Ymarker = "CD24",dim=0.5)
plot.scatter(celldata, "k20", 22, Xmarker = "F480", Ymarker = "CD44",dim=0.6)
plot.scatter(celldata, "k20", 22, Xmarker = "CD68", Ymarker = "CD44",dim=0.6)
plot.scatter(celldata, "k20", 23, Xmarker = "CD11c", Ymarker = "CD44",dim=0.7)
plot.scatter(celldata, "k20", 23, Xmarker = "MHCcII", Ymarker = "CD44",dim=1)
plot.scatter(celldata, "k20", 23, Xmarker = "MHCcII", Ymarker = "CD103",dim=0.7)
plot.scatter(celldata, "k20", 25, Xmarker = "F480", Ymarker = "EPCAM",dim=0.5)
plot.scatter(celldata, "k20", 21, Xmarker = "LY6G", Ymarker = "Ly6C",dim=1.5)
plot.scatter(celldata, "k20", 32, Xmarker = "PancK", Ymarker = "aSMA",dim=3)
plot.scatter(celldata, "k20", 26, Xmarker = "PECAM", Ymarker = "CD44",dim=1)


plot.scatter(celldata, "kinv25", 23, Xmarker = "CD11c", Ymarker = "MHCcII",dim=1)
#plot.scatter3(celldata, "kinv25", 26, "CD4", "Foxp3", "ExpGroup")
ggplot(celldata, aes(x = MI_MHCcII, y = MI_CD11c)) +
  xlim(0,2)+
  ylim(0,2)+
   geom_point(color = "blue", alpha = 0.7) +
  theme_minimal() 


```


## Making heatmap for anncluster
```{r} 
# In this step, the order is also important 
lin_markers = c("CD45", "CD3e", "CD4", "Foxp3", "CD8a","B220",  "CD11c", "MHCII","CD103", 
"F480","CD68", "CD11b", "LY6G","Ly6C","EpCAM","CK19","aSMA","PECAM","CD44")
#checking the name


excl_cols = c("MI_TumourminusInterface", "MI_NormalminusInterface","MI_StructuralImage",
 "MI_InterfaceImage", "MI_Xenon131", "MI_Xenon132", "MI_DNA1",
  "MI_DNA2", "MI_Argon80")
mismatch_names <- setdiff(excl_cols, colnames(celldata))
print(mismatch_names) 
all_markers = grep("MI_", names(celldata), value = T)
all_markers = all_markers[!all_markers %in% excl_cols] %>%
  str_remove(pattern = "MI_")

lin_markers_check<- lin_markers[!lin_markers %in% all_markers]
lin_markers_check
# check the mismateched colnames and if character(0)then go on
#mismatch_names <- setdiff(lin_markers, colnames(celldata))
#print(mismatch_names)

# in this step ,  choose right K value, by testing different kinv and lin_marker to get best annotation .
unique(celldata$k15)#37 cluster
unique(celldata$k20)#32 cluster
unique(celldata$k20)#31 cluster
unique(celldata$k30)#30 cluster
# roughly comparing , I use k 20 for further analysis

# set the marker order of markerlist   


plot.heatmap2(celldata, lin_markers, "k20", title = "Cluster k20", Colv = F, srtCol = 90,scale = "column")
plot.heatmap2(celldata, lin_markers, "k20", title = "Cluster k20", Colv = F, srtCol = 90,scale = "column")
# will not choose K20 becasue CD3  single positvie cluster
plot.heatmap2(celldata, lin_markers, "k20", title = "Cluster k20", Colv = F, srtCol = 90,scale = "column")
plot.heatmap2(celldata, lin_markers, "k20", title = "Cluster k20", Colv = F, srtCol = 90,scale = "column")

# annoation based on k20
## IF colv =F ,then cluster name followed as cluster1-31, if Row=F . then rownames followed the lin_marker order.
plot.heatmap2(celldata, lin_markers, "k20", title = "Cluster k20", Colv = F,Rowv = F, srtCol = 90,scale = "row")
plot.heatmap2(celldata, all_markers, "k20", title = "Cluster k20", Colv = F,Rowv = F, srtCol = 90,scale = "column")

#save as both pdf and tiff/jpg
pdf(file = paste0(OUTPUT_PATH,"/Heatmap/lin_makers_expression_k20.pdf"),width = 10,height = 6)
plot.heatmap2(celldata, lin_markers, "k20",
              title = "lin_marker_expression",
              margins = c(10, 9), srtCol = 55, transpose = F,Colv = F,Rowv = F,scale = "column")
dev.off()




# plot.heatmap2(celldata, lin_markers, "k20", title = "Cluster k20",margins=c(1,0.5), Colv = T, srtCol = 90,barplot = c("ExpGroup","ROI_ID"))
# plot.heatmap2(celldata, all_markers, "kinv25", title = "Cluster k40",margins=c(10,9),
#               Colv = T, srtCol = 90)
# plot.heatmap2(celldata, lin_markers, "kinv25", title = "Cluster k40",
#               Colv = T, srtCol = 90)
# # IF THE IMAGE DOESNT FIT THE  SIZE, MAYBE SET THE MARIN . 
# plot.heatmap2(celldata, lin_markers, "kinv25", title = "Cluster k40",key.par = list(mar = c(4,0.3,3,0.5)),
#               Colv = T, srtCol = 90)        


# plot.bp = function(clustern) {
#   filename = file.path(file.path(output_path, "Figures/ClusterSpread"),
#                        paste0(date, "_cluster", clustern, ".jpeg"))
#   jpeg(filename = filename, width = 700, height = 600, units = "px")
#   par(mar=c(8,3,0.8,0.8))
#    # par(mar=c(11,4,1,1))
#   barplot(table(celldata[celldata$kinv40 == clustern, "filename"]),
#                         las = 2, cex.names = 0.8)
#   dev.off()
# }
#sapply(c(1:34), plot.bp)
#scale ="rows can also be helpful to annotate "
plot.heatmap2(celldata, lin_markers, "kinv25", title = "Cluster k40",
              Colv = T, srtCol = 90, barplot = c("ExpGroup", "ROI_ID"), scale = "row")
plot.heatmap2(celldata, lin_markers, "kinv25", title = "Cluster k40",
              Colv = T, srtCol = 90, barplot = c("ExpGroup", "ROI_ID"), scale = "column")
```

R manual annotation  k20
```{r manual annotation}
# # Manually assign cluster labels ,current K20
celldata$anncluster = stringr::str_pad(celldata$k20, 2, side="left", pad="0") 
unique(celldata$anncluster)
# Split clusters based on thresholds for marker intensities
celldata[which(celldata$anncluster == "12"
               & celldata$MI_Foxp3 >= 0.3), "anncluster"] = "12A"
celldata[which(celldata$anncluster == "12"), "anncluster"] = "12B"
##  21  split  to neutrophils and CD11b single positive celsl


#split 21 tomono an neutropihls
celldata[which(celldata$anncluster == "21"
               & celldata$MI_LY6G > 0.3), "anncluster"] = "21A" # cehckede 0.25  similar to 0.3   0.4 is too high 
celldata[which(celldata$anncluster == "21"), "anncluster"] = "21B"


#split 17 to DC103 and uncertain 
celldata[which(celldata$anncluster == "17"
               & celldata$MI_CD103 > 1.5), "anncluster"] = "17A" # cehckede 0.25  similar to 0.3   0.4 is too high 
celldata[which(celldata$anncluster == "17"), "anncluster"] = "17B"


#250218 varified by xiaofei 

celldata[which(celldata$anncluster == "01"), "anncluster"] = "01_B cells" # checked 
celldata[which(celldata$anncluster == "02"), "anncluster"] = "02_Tumour" # checked
celldata[which(celldata$anncluster == "03"), "anncluster"] = "03_Tumour"#c checked
celldata[which(celldata$anncluster == "04"), "anncluster"] = "04_Tumour"# Also see loe MHCII expression ,but negative for all other markers
celldata[which(celldata$anncluster == "05"), "anncluster"] = "05_Macrophages"#with highly CD11c, CD68+CD11c+
celldata[which(celldata$anncluster == "06"), "anncluster"] = "06_Macrophages"# checked
celldata[which(celldata$anncluster == "07"), "anncluster"] = "07_Tumour"#checked
celldata[which(celldata$anncluster == "08"), "anncluster"] = "08_Fibroblasts"#checked
celldata[which(celldata$anncluster == "09"), "anncluster"] = "09_Dendritic cells"# checked with febe, from umap it is dc 
celldata[which(celldata$anncluster == "10"), "anncluster"] = "10_Tumour" # umap shows more like tumour ,also not typical CK19+area 
celldata[which(celldata$anncluster == "11"), "anncluster"] = "11_Endothelium"# also express ly6c
celldata[which(celldata$anncluster == "12A"), "anncluster"] = "12A_Tregs" #
celldata[which(celldata$anncluster == "12B"), "anncluster"] = "12B_T cell CD4" #
celldata[which(celldata$anncluster == "13"), "anncluster"] = "13_Endothelium"#Endotheliem ,also MHCII+
celldata[which(celldata$anncluster == "14"), "anncluster"] = "14_Tumour"
celldata[which(celldata$anncluster == "15"), "anncluster"] = "15_Tumour"
celldata[which(celldata$anncluster == "16"), "anncluster"] = "16_Neutrophils"# almost all express ly6g
celldata[which(celldata$anncluster == "17A"), "anncluster"] = "17A_Uncertain"
celldata[which(celldata$anncluster == "17B"), "anncluster"] = "17B_Dendritic cells CD103"
celldata[which(celldata$anncluster == "18"), "anncluster"] = "18_T cell CD8"
celldata[which(celldata$anncluster == "19"), "anncluster"] = "19_Epithelium"#mainlyCLK19 ,clear epitheliums, airway 
celldata[which(celldata$anncluster == "20"), "anncluster"] = "20_Tumour"  
celldata[which(celldata$anncluster == "21A"), "anncluster"] = "21A_Neutrophils"# will split to neutrphils and monocytes
celldata[which(celldata$anncluster == "21B"), "anncluster"] = "21B_Monocytes" # cutoff setting by images
celldata[which(celldata$anncluster == "22"), "anncluster"] = "22_Macrophages" # totally split in UMAP   in 32566e images, it is macrophages clear . 
celldata[which(celldata$anncluster == "23"), "anncluster"] = "23_Tumour" # few
celldata[which(celldata$anncluster == "24"), "anncluster"] = "24_Endothelium" # or tumour?
celldata[which(celldata$anncluster == "25"), "anncluster"] = "25_Tumour" # checked ,F480 is very low and mainly spillover
celldata[which(celldata$anncluster == "26"), "anncluster"] = "26_Endothelium"  # check cutoff 
celldata[which(celldata$anncluster == "27"), "anncluster"] = "27_Endothelium" #  also express ly6c
celldata[which(celldata$anncluster == "28"), "anncluster"] = "28_Fibroblasts" #  
celldata[which(celldata$anncluster == "29"), "anncluster"] = "29_Tumour"# no cluster in 3371 5a mainly554b-2 
celldata[which(celldata$anncluster == "30"), "anncluster"] = "30_Macrophages"#all few checked
celldata[which(celldata$anncluster == "31"), "anncluster"] = "31_Epithelium"#no cluster in 33715a. all few
celldata[which(celldata$anncluster == "32"), "anncluster"] = "32_Uncertain" #TCRgrt?   not much in all images double positive
celldata[which(celldata$anncluster == "33"), "anncluster"] = "33_Fibroblasts"
celldata[which(celldata$anncluster == "34"), "anncluster"] = "34_Uncertain"#  mainly edge, possible real uncertain
# Generate cluster annotation --------------------------------------------------
# Description : Helper function to generate an column with manual annotation
#               from a column with string converted (sub)clusters.
# ---Parameters---
# clusterCol  --> [vector] a vector of strings representing (sub)cluster numbers
# << Output >>    [vector] A vector of cluster numbers followed by an underscore
#                 and the respective manual annotation of the cluster


# split 04 into DC ,MAC and tumour

# celldata[celldata$anncluster == "21" &
#          celldata$MI_LY6G >= 0.5, "anncluster"] = "21A" # mac
#          # celldata$MI_F480 >= 0.35|celldata$MI_CD68 >= 0.25, "anncluster"] = "04A" # mac
# celldata[celldata$anncluster == "21"&
#            celldata$MI_MHCcII >= 0.5|celldata$MI_CD11c >= 0.7, "anncluster"] = "04B" # dc
# celldata[celldata$anncluster == "04B"&
#            celldata$MI_MHCcII < 0.55, "anncluster"] = "04A" # mac
# celldata[celldata$anncluster == "04", "anncluster"] = "04C"#Tumour
# 4  mac and tumour and CD11c
# # add a B cell cluster 
# celldata[celldata$MI_B220 >= 0.3, "anncluster"] = "33"  
# celldata[celldata$MI_B220 >= 0.3 &
#            celldata$MI_CollagenI >= 0.5, "anncluster"] = "34"


unique(celldata$anncluster)
# Generate a column "cluster2" that makes a string out of the cluster numbers
# celldata$anncluster = annotate.cluster(celldata$anncluster)

celldata$annotation = str_split(celldata$anncluster,
                                      pattern = "_", simplify = TRUE)[,2]
unique(celldata$annotation)
annlevels = c("Tumour", "Fibroblasts", "Endothelium", "Epithelium",
           "T cell CD8", "T cell CD4", "Tregs","CD8TCRgdt", "Dendritic cells",
           "Dendritic cells CD103", "Macrophages", "Neutrophils", "Monocytes","B cells", "Uncertain")
celldata$annotation = factor(celldata$annotation, levels = annlevels)
table(celldata$anncluster)
table(celldata$annotation)
celldata_count_perROI= celldata %>%
     group_by(anncluster,ROI_ID) %>%
     dplyr::summarise(totaln=n())
 View(celldata_count_perROI)

# Order the levels of the annotation column
plot.heatmap2(celldata, all_markers, "anncluster", title = "Annotated clusters",  margins = c(10, 5), srtCol = 60, Colv = T)
plot.heatmap2(celldata, lin_markers, "anncluster", title = "Annotated clusters",  margins = c(10, 5), srtCol = 60, Colv = T)
plot.heatmap2(celldata, lin_markers, "anncluster", title = "Annotated clusters",  margins = c(10, 5), srtCol = 60, Colv = T,scale = "row")
```
```{r}
## add  a new column cell_type for making heatmap or plot 
celldata$cell_type<-celldata$annotation
celldata$cell_type[celldata$cell_type=="Macrophages"]<-"Macrophages"
celldata$cell_type[celldata$cell_type=="Fibroblasts"]<-"Fibroblasts"
celldata$cell_type[celldata$cell_type=="Dendritic cells CD103"]<-"Dendritic cells"
celldata$cell_type[celldata$cell_type=="Dendritic cells"]<-"Dendritic cells"
celldata$cell_type[celldata$cell_type=="T cells CD4"]<-"CD4 T cells"
celldata$cell_type[celldata$cell_type=="T cells CD8"]<-"CD8 T cells"
celldata$cell_type[celldata$cell_type=="Tregs"]<-"Treg cells"
celldata$cell_type[celldata$cell_type=="TCRgdt"]<-"TCRgdt cells"
celldata$cell_type[celldata$cell_type=="Uncertain"]<-"Uncertain"# only has cluster in 33715a ,so uncertain due to multiple marker expressing . 
unique(celldata$cell_type)
```


#plot manual annotation results. 
```{r manual annotation}
# plot.heatmap2(celldata, lin_markers, "anncluster", title = "Annotated clusters",   margins = c(10, 5), srtCol = 60, Colv = T,key.par = list(mar = c(4,0.3,3,0.5)))
# plot.heatmap2(celldata, lin_markers, "annotation",
#               title = "Cell type expression pattern",
#               margins = c(10, 9), srtCol = 55, transpose = T,scale = "row",key.par = list(mar = c(4,0.3,3,0.5)))
plot.heatmap2(celldata, lin_markers, "anncluster", title = "Annotated clusters", scale = "row",  margins = c(10, 5), srtCol = 60, Colv = T)
plot.heatmap2(celldata, lin_markers, "anncluster", title = "Annotated clusters",  margins = c(10, 5), srtCol = 60, Colv = T)
#making pdf
pdf(file = paste0(OUTPUT_PATH,"/Heatmap/all_makers_expression_anncluster.pdf"),width = 8,height = 8)
plot.heatmap2(celldata, all_markers, "anncluster",
              title = "all_marker_expression",
              margins = c(10, 9), srtCol = 55, transpose = F,Colv = T,Rowv = T,scale = "column")
dev.off()
pdf(file = paste0(OUTPUT_PATH,"/Heatmap/cell_type_expression_allmarker.pdf"),width = 8,height = 6)
plot.heatmap2(celldata, all_markers, "annotation",
              title = "Cell type expression pattern",
              margins = c(10, 9), srtCol = 55, transpose =T,scale = "column")
dev.off()

pdf(file = paste0(OUTPUT_PATH,"/Heatmap/lin_markers_expression.pdf"),width = 8,height = 6)
plot.heatmap2(celldata, lin_markers, "anncluster", title = "Annotated clusters",   margins = c(10, 5), srtCol = 60, Colv = T)
dev.off
pdf(file = paste0(OUTPUT_PATH,"/Heatmap/lin_markers_expression.pdf"),width = 8,height = 6)
plot.heatmap2(celldata, lin_markers, "annotation", title = "lin_Marker Expression",   margins = c(10, 5), srtCol = 60, Colv = T)
dev.off
pdf(file = paste0(OUTPUT_PATH,"/Heatmap/lin_markers_expression.pdf"),width = 8,height = 6)
plot.heatmap2(celldata, all_markers, "annotation", title = "all_Marker Expression",   margins = c(10, 5), srtCol = 60, Colv = T)
dev.off
```





# checking and revise annotation --- umap checking  and ggplot checking 
## Umap 
### based on primary annotation , checking marker expression location 
###define UMAP 
```{r}
# Generate new UMAP ------------------------------------------------------------
# Description : Generate a new UMAP with the selected clusters and markers
# ---Parameters---
# celldata  --> [dataframe] a dataframe with mean intensity data by marker
# clusters  --> [vector] a vector with levels of the factor 'anncluster' that should be included
# markers   --> [vector] a vector with column names of celldata with marker
#               expression data that should be used to generate the UMAP
# nsample   --> [numeric] the number of cells that should be subsampled from celldata
# << Output >>  [dataframe] the selected subset of celldata with UMAP coordinates
generate.UMAP = function(celldata, clusters, markers, nsample, filename) {
  data = celldata[celldata$anncluster %in% clusters,]
  data = data[sample(x = nrow(data), size = nsample),]
  umapResults = umap(data[,markers], verbose = T, n_neighbors = 10)
  data$umap1 = umapResults$layout[,1]
  data$umap2 = umapResults$layout[,2]
  write.csv(x = data, file = file.path(OUTPUT_PATH, filename), row.names = T)
  return(data)
}

# Plot UMAP -------------------------------------------------------------------
# Description : Plot cells on a plane according to their UMAP coordinates,
#               coloured according to levels of factor 
# ---Parameters---
# UMAPdf    --> [dataframe] a dataframe with UMAP data.
# factor    --> [string] name of a column of 'UMAPdf' that acts as a factor
# celltype  --> [string] a string that represents the type of cells in the UMAP
# lgndttl   --> [string] the title of plot legend
# << Output >>  [image] the generated UMAP
plot.UMAP = function(UMAPdf, factor, celltype, lgndttl) {
  factor = sym(factor)
  
  p = ggplot(UMAPdf, aes(x=umap1, y=umap2, colour = !!factor)) + 
    geom_point(size = 0.3) +
    guides(colour = guide_legend(override.aes = list(size=5), title = lgndttl)) +
    scale_color_manual(values = cluster_cols) + ggtitle(celltype) + 
    theme_classic() + labs(x = "UMAP 1", y = "UMAP 2") +
    theme(plot.background = element_blank(),
          axis.title = element_text(size = 15),
          legend.text = element_text(size = 15),
          legend.title = element_text(size = 17, face = "bold"),
          plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
          panel.grid = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank())
  
  celltype = str_replace_all(celltype, " ", "_")
  lgndttl = str_replace_all(lgndttl, " ", "_")
  filename = paste0("UMAP_", celltype, "_", lgndttl, ".jpeg")
  
  directory = create.resultsdir(path = OUTPUT_PATH,
                                name = paste0(celltype, "_UMAP"))
  
  ggsave(filename = filename, path = directory,
         bg = "white", width = 2100, height = 1700, units = "px")
  
  print(p)
}

# Plot UMAP -------------------------------------------------------------------
# Description : Plot cells on a plane according to their UMAP coordinates,
#               coloured according to their expression of 'marker'  
# ---Parameters---
# UMAPdf    --> [dataframe] a dataframe with UMAP data.
# marker    --> [string] name of a column of 'UMAPdf' with expression data of a marker
# celltype  --> [string] a string that represents the type of cells in the UMAP
# << Output >>  [image] the generated UMAP
plot.UMAPmarker = function(UMAPdf, marker, celltype) {
  colour = sym(marker)
  title = paste(celltype, str_remove(marker, "MI_"), "expression")
  p = ggplot(UMAPdf, aes(x=umap1, y=umap2, colour = !!colour)) + 
    geom_point(size = 0.3) + ggtitle(title) + 
    theme_classic() + labs(x = "UMAP 1", y = "UMAP 2") +
    theme(plot.background = element_blank(),
          axis.title = element_text(size = 15),
          legend.text = element_text(size = 15),
          legend.title = element_blank(),
          plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
          panel.grid = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank()) +
    scale_color_distiller(palette = "Spectral", limits = c(0,3))
  
  celltype = str_replace_all(celltype, " ", "_")
  filename = paste0("UMAP_", celltype, "_", str_remove(marker, "MI_"), ".jpeg")
  
  directory = create.resultsdir(path = OUTPUT_PATH,
                                name = paste0(celltype, "_UMAP"))
  
  ggsave(filename = filename, path = directory,
         bg = "white", width = 2100, height = 1700, units = "px")
  
  print(p)
}

cluster_cols = c( "#FFF4A4FF",  "#ABDDA4FF", "#618F75FF",  "#336666",
               "#4E79A7FF", "#A0CBE8FF","#938ABBFF",  "#B07AA1FF",
               "#FF9D9AFF", "#CC6666",  "#704850FF",  "#8C8C8C", "#FFD700",   "#00FF7F",   "#8B4513",  "#FF6347",  "#40E0D0",   "#7FFF00",  
  "#DC143C", "#8B0000","#F0E442", "#0072B2", "#D55E00", "#CC79A7", 'red','pink','purple','blue',"#8FBC8B", "#6A5ACD", "#4682B4", "#FF4500", "#2E8B57",
"#483D8B", "#FF1493", "#FF8C00", "#98FB98", "#556B2F",
"#CD5C5C", "#00008B", "#FFDAB9", "#BA55D3", "#87CEEB",
"#B0E0E6", "#5F9EA0")


```

##
```{r new UMAPs}
get.clusters = function(patterns) {
  clusters = sapply(X = patterns, FUN = grep, x = unique(celldata$anncluster), value = T)
  clusters = unlist(clusters, use.names = F)
  return(clusters)
} 

if (F) {
  # T cells
  TCellClusters = get.clusters(patterns = c("T cell","TCR","Treg"))
  Tcell_lineage=c("MI_CD3e", "MI_CD45", "MI_CD4", "MI_CD8a", "MI_Foxp3", "MI_TCRgdt")
  TCellMarkers = c("MI_CD3e", "MI_CD45", "MI_CD4", "MI_CD8a", "MI_Foxp3",
 "MI_LAG3", "MI_PD1", "MI_TCRgdt", "MI_TIM3")
  print(TCellClusters)
# TColumns = c("CD103", "CD3e", "CD45", "CD4",  "Foxp3", "Ki67", "LAG3","CD8a",
#  "PD1", "Casp3")
# TColumns = paste0("MI_", TColumns)
#   TCclusters = c("09B_T cells CD4", "09A_Tregs","28_T cells CD8")
# print(TCclusters)
set.seed(222)
  TCD = generate.UMAP(celldata = celldata, clusters = TCellClusters,
                      markers = Tcell_lineage, nsample = 4000, filename = "250221TCD.csv")
set.seed(111)  
  # Macrophages & Dendritic cells
  MacDendCellClusters = get.clusters(patterns = c("Macrophage", "Dendritic","DC"))
  MacDendCellColumns = c("MI_MHCcII", "MI_F480", "MI_CD103", "MI_PDL1", "MI_CD86",
                         "MI_CD68", "MI_CD206",  "MI_CD11c", "MI_CD11b", "MI_CD44") #, "MI_LY6G",  "MI_CD44")
  MacDendCD = generate.UMAP(celldata = celldata, clusters = MacDendCellClusters,
                            markers = MacDendCellColumns, nsample = 20000,
                            filename = "241212MacDendCD.csv")
  
   set.seed(222)  
  # Macrophages & Dendritic cells
  MacDendTumCellClusters = get.clusters(patterns = c("Macrophage", "Dendritic","DC","Tumour"))
  MacDendTumCell_lineage = c("MI_MHCII", "MI_F480", "MI_CD103","MI_CD11c",
                         "MI_CD68", "MI_CD206",  "MI_CD11c", "MI_CD44") #, "MI_LY6G",  "MI_CD44")
  MacDendTumCellColumns = c("MI_MHCII", "MI_F480", "MI_CD103", "MI_PDL1", "MI_CD86",
                         "MI_CD68", "MI_CD206",  "MI_CD11c", "MI_CD11b","MI_LY6G","MI_PVR","MI_CD44","MI_CD11c","MI_PDL1") #, "MI_LY6G",  "MI_CD44")
  MacDendTumCD = generate.UMAP(celldata = celldata, clusters = MacDendTumCellClusters,
                            markers = MacDendTumCellColumns, nsample = 20000,
                            filename = "250218MacDendTumCD.csv")
  
  set.seed(222)  
  # Macrophages & Dendritic cells
  MacDendNeuMonoCellClusters = get.clusters(patterns = c("Macrophage", "Dendritic","DC","Neutrophils","Mono"))
  MacDendNeuMonoCell_lineage = c("MI_MHCII", "MI_F480", "MI_CD103", "MI_Ly6C",
                         "MI_CD68", "MI_CD206",  "MI_CD11c", "MI_CD11b","MI_LY6G") 
  MacDendNeuMonoCellColumns = c("MI_MHCII", "MI_F480", "MI_CD103", "MI_PDL1", "MI_CD86","MI_Ly6C",
                         "MI_CD68", "MI_CD206",  "MI_CD11c", "MI_CD11b","MI_LY6G",  "MI_CD44") #, "MI_LY6G",  "MI_CD44")
  MacDendNeuMonoCD = generate.UMAP(celldata = celldata, clusters = MacDendNeuMonoCellClusters,
                            markers = MacDendNeuMonoCell_lineage, nsample = 20000,
                            filename = "250221MacDendNeuMonoCD.csv")
  
  
 set.seed(222)
    # Macrophages
  MacCellClusters = get.clusters(patterns = c("Macrophage"))
  MacCellColumns = c("MI_MHCcII", "MI_F480", "MI_CD103", "MI_PDL1", "MI_CD86",
                         "MI_CD68", "MI_CD206", "MI_CD11c", "MI_CD11b","MI_LY6G",  "MI_CD44") #, "MI_LY6G",  "MI_CD44")
  MacCD = generate.UMAP(celldata = celldata, clusters = MacCellClusters,
                            markers = MacCellColumns, nsample = 20000,
                            filename = "241101MacCD.csv")
  
  
  
  
 set.seed(222) 
  # Tumour cells
  TUMClusters = get.clusters(patterns = c("Tumour"))
  TUMColumns =  c("MI_EPCAM", "MI_PancK","MI_PVR","MI_casp3","MI_CD44","MI_PDL1","MI_Ki67","MI_pS6","MI_CD24")#, "MI_PDL1",  "MI_CD44")
  TUMCD = generate.UMAP(celldata = celldata, clusters = TUMClusters,
                        markers = TUMColumns, nsample = 20000,
                        filename = "241101TUMCD.csv")
  #TumourFibNeu cells
 set.seed(222)
   TumourFibEndoEpiClusters = get.clusters(patterns = c("Tumour","Fibroblasts","Endo","Epi","Uncertain"))
   TumourFibEndoEpi_lineage= c("MI_EpCAM","MI_CK19", "MI_CD44", "MI_aSMA", "MI_PECAM","MI_MHCII","MI_CD11c")#MHCII CD11c is because of cluster 4
   TumourFibEndoEpiColumns =  c("MI_EpCAM", "MI_CK19","MI_PVR","MI_Casp3","MI_CD44","MI_PDL1","MI_Ki67","MI_pS6","MI_aSMA","MI_Vimentin","MI_PECAM","MI_MHCII","MI_CD11c")#, "MI_PDL1",  "MI_CD44")
     TumourFibEndoEpiCD = generate.UMAP(celldata = celldata, clusters = TumourFibEndoEpiClusters,
                        markers = TumourFibEndoEpi_lineage, nsample = 20000,
                        filename = "250218TumourFibEndoEpiCD")
  
  set.seed(222)# Fibroblasts & endothelial cells
  FibEndoClusters = get.clusters(patterns = c("Fibroblasts", "Endo"))
  FibEndoColumns = c("MI_aSMA", "MI_PDL1", "MI_Thy1_2", "MI_Vimentin",
                     "MI_CollagenI", "MI_PECAM")
  FibEndoCD = generate.UMAP(celldata = celldata, clusters = FibEndoClusters,
                            markers = FibEndoColumns, nsample = 20000,
                            filename = "241101FibEndoCD.csv")
set.seed(222)
MacFibTumNeuClusters= get.clusters(patterns = c("Tumour","Fibroblasts","Macrophages",'Neutrophils',"Dendritic"))
MacFibTumNeuClusters
MacFibTumNeuColumns =  c("MI_EPCAM","MI_PancK","MI_PVR","MI_casp3","MI_CD44","MI_PDL1","MI_Ki67","MI_pS6","MI_CD11b","MI_LY6G","MI_aSMA","MI_Vimentin","MI_MHCcII", "MI_F480", "MI_CD103", "MI_PDL1", "MI_CD86",  "MI_CD68", "MI_CD206",  "MI_CD11c","MI_CollagenI")
MacFibTumNeuCD= generate.UMAP(celldata = celldata, clusters = MacFibTumNeuClusters,
                            markers = MacFibTumNeuColumns, nsample = 20000,
                            filename = "241206MacDendFibTumNeuCD.csv")

set.seed(222)
CellClusters= unique(celldata$anncluster)
CellClusters
# code for all_markers
lineage_marker=c("MI_CD45", "MI_CD4", "MI_CD3e", "MI_CD8a","MI_B220","MI_Foxp3",
              "MI_CD68",  "MI_EpCAM", "MI_F480",  "MI_LY6G","MI_CD103", "MI_CD11b", "MI_CD11c", "MI_MHCII", "MI_Ly6C",
              "MI_PECAM", "MI_aSMA",  "MI_CD44", "MI_CK19")
CellColumns<-lineage_marker
all_markers = all_markers[!all_markers %in% excl_cols]
CellColumns <- paste0("all_markers = c(", paste0('"', lineage_marker, '"', collapse = ","), ")")
# Print the formatted string
cat(CellColumns)
CellColumns = c("MI_B220","MI_CD103","MI_CD11b","MI_CD11c","MI_CD206","MI_CD3e","MI_CD44","MI_CD45","MI_CD4","MI_CD68","MI_CD86","MI_CD8a","MI_CK19","MI_CXCL9","MI_Casp3","MI_EpCAM","MI_F480","MI_Foxp3","MI_Ki67","MI_LAG3","MI_LY6G","MI_Ly6C","MI_MGL2","MI_MHCII","MI_NK1_1","MI_PD1","MI_PDL1","MI_PDPN","MI_PECAM","MI_PVR","MI_Sirpa","MI_TCRgdt","MI_TIM3","MI_Thy1_2","MI_Vimentin","MI_aSMA","MI_pS6")

CellCD= generate.UMAP(celldata = celldata, clusters = CellClusters,
                            markers = CellColumns, nsample = 20000,
                            filename = "250221CellCD.csv")

  }

```

###plot umap function 

```{r}
# Define the function to plot UMAP
plot_umap <- function(data, color_var, plot_title, legend_title, file_name, subfolder) {

# Create the ggplot
p <- ggplot(data, aes(x=umap1, y=umap2, colour = as.factor(data[[color_var]]))) + 
  geom_point(size = 0.3) + 
  ggtitle(plot_title) + 
  guides(colour = guide_legend(override.aes = list(size = 5), title = legend_title)) +
  theme_classic() + 
  labs(x = "UMAP 1", y = "UMAP 2") +
  theme(plot.background = element_blank(),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 10, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        panel.grid = element_blank(),
        axis.ticks = element_blank()) +
  scale_color_manual(values = cluster_cols)
# Save the plot
ggsave(filename = file_name,
       path = file.path(OUTPUT_PATH,subfolder),
       bg = "white",
       width = 2100, height = 1700, units = "px")
return(p)
}
# T cell 
plot_umap(TCD,color_var = "anncluster",plot_title="U-MAP T cells",legend_title = "Clusters",file_name="UMAP_T_cell_cluster.jpeg",subfolder = "UMAP/T_Cell_markers")
plot_umap(TCD,color_var = "annotation",plot_title="U-MAP T cells",legend_title = "Annotation",file_name="UMAP_T_cell_annotation.jpeg",subfolder = "UMAP/T_Cell_markers")
plot_umap(TCD,color_var = "ExpGroup",plot_title="U-MAP T cells",legend_title = "Group",file_name="UMAP_T_cell_group.jpeg",subfolder = "UMAP/T_Cell_markers")
# Myloid cell
MacDendCD_filter<-MacDendCD
MacDendCD_filter= MacDendCD_filter[MacDendCD_filter$umap1<10,]
MacDendCD_filter= MacDendCD_filter[MacDendCD_filter$umap2<15,]
#ggplot(MacDendCD_filter,aes(x=umap1,y=umap2,colour="ExpGroup"))
plot_umap(MacDendCD_filter,color_var = "anncluster",plot_title="U-MAP MacDend cells",legend_title = "Clusters",file_name="UMAP_MacDendCD_cluster.jpeg",subfolder = "UMAP/MacDendCD_markers")
plot_umap(MacDendCD_filter,color_var = "annotation",plot_title="U-MAP MacDend cells",legend_title = "Annotation",file_name="UMAP_MacDendCD_annotation.jpeg",subfolder = "UMAP/MacDendCD_markers")
plot_umap(MacDendCD_filter,color_var = "ExpGroup",plot_title="U-MAP MacDend cells",legend_title = "Group",file_name="UMAP_MacDendCD_group.jpeg",subfolder = "UMAP/MacDendCD_markers")


MacDendNeuMonoCD_filter<-MacDendNeuMonoCD
MacDendNeuMonoCD_filter= MacDendNeuMonoCD_filter[MacDendNeuMonoCD_filter$umap1>-20,]
MacDendNeuMonoCD_filter= MacDendNeuMonoCD_filter[MacDendNeuMonoCD_filter$umap2>-15,]
#ggplot(MacDendCD_filter,aes(x=umap1,y=umap2,colour="ExpGroup"))
plot_umap(MacDendNeuMonoCD_filter,color_var = "anncluster",plot_title="U-MAP MacDendNeu cells",legend_title = "Clusters",file_name="UMAP_MacDendNeuMonoCD_cluster.jpeg",subfolder = "UMAP/MacDendNeuMonoCD_markers")
plot_umap(MacDendNeuMonoCD_filter,color_var = "annotation",plot_title="U-MAP MacDendNeu cells",legend_title = "Annotation",file_name="UMAP_MacDendNeuMonoCD_annotation.jpeg",subfolder = "UMAP/MacDendNeuMonoCD_markers")
plot_umap(MacDendNeuMonoCD_filter,color_var = "ExpGroup",plot_title="U-MAP MacDendNeu cells",legend_title = "Group",file_name="UMAP_MacDendNeuMonoCD_group.jpeg",subfolder = "UMAP/MacDendNeuMonoCD_markers")

MacDendTumCD_filter<-MacDendTumCD
MacDendTumCD_filter= MacDendTumCD_filter[MacDendTumCD_filter$umap1<10,]
MacDendTumCD_filter= MacDendTumCD_filter[MacDendTumCD_filter$umap2>-15,]
#ggplot(MacDendCD_filter,aes(x=umap1,y=umap2,colour="ExpGroup"))
plot_umap(MacDendTumCD_filter,color_var = "anncluster",plot_title="U-MAP MacDendTum cells",legend_title = "Clusters",file_name="UMAP_MacDendTumCD_cluster.jpeg",subfolder = "UMAP/MacDendTumCD_markers")
plot_umap(MacDendTumCD_filter,color_var = "annotation",plot_title="U-MAP MacDendTum cells",legend_title = "Annotation",file_name="UMAP_MacDendTumCD_annotation.jpeg",subfolder = "UMAP/MacDendTumCD_markers")
plot_umap(MacDendTumCD_filter,color_var = "ExpGroup",plot_title="U-MAP MacDendTum cells",legend_title = "Group",file_name="UMAP_MacDendTumCD_group.jpeg",subfolder = "UMAP/MacDendTumCD_markers")



# Tumor cell
plot_umap(TUMCD,color_var = "anncluster",plot_title="U-MAP Tumour cells",legend_title = "Clusters",file_name="UMAP_TUMCD_cluster.jpeg",subfolder = "UMAP/TUMCD_markers")
plot_umap(TUMCD,color_var = "annotation",plot_title="U-MAP Tumour cells",legend_title = "Annotation",file_name="UMAP_TUMCD_annotation.jpeg",subfolder = "UMAP/TUMCD_markers")
plot_umap(TUMCD,color_var = "ExpGroup",plot_title="U-MAP Tumour cells",legend_title = "Group",file_name="UMAP_TUMCD_group.jpeg",subfolder = "UMAP/TUMCD_markers")

#fib+Tumor+endo +epi
TumourFibEndoEpiCD_filter<-TumourFibEndoEpiCD
TumourFibEndoEpiCD_filter= TumourFibEndoEpiCD_filter[TumourFibEndoEpiCD_filter$umap1<15,]
TumourFibEndoEpiCD_filter= TumourFibEndoEpiCD_filter[TumourFibEndoEpiCD_filter$umap2>-20,]
plot_umap(TumourFibEndoEpiCD_filter,color_var = "anncluster",plot_title="U-MAP TumourFibEndoEpiCD cells",legend_title = "Clusters",file_name="UMAP_TumourFibEndoEpiCD_cluster.jpeg",subfolder = "UMAP/TumourFibEndoEpiCD_markers")
plot_umap(TumourFibEndoEpiCD_filter,color_var = "annotation",plot_title="U-MAP TumourFibEndoEpiCD cells",legend_title = "Annotation",file_name="UMAP_TumourFibEndoEpiCD_annotation.jpeg",subfolder = "UMAP/TumourFibEndoEpiCD_markers")
plot_umap(TumourFibEndoEpiCD_filter,color_var = "ExpGroup",plot_title="U-MAP TumourFibEndoEpiCD cells",legend_title = "Group",file_name="UMAP_TumourFibEndoEpiCD_group.jpeg",subfolder = "UMAP/TumourFibEndoEpiCD_markers")

#CellCD
CellCD_filter<-CellCD
CellCD_filter= CellCD_filter[CellCD_filter$umap1>-10,]
CellCD_filter= CellCD_filter[CellCD_filter$umap2>-10,]
plot_umap(CellCD_filter,color_var = "anncluster",plot_title="U-MAP all cells",legend_title = "Clusters",file_name="UMAP_CellCD_cluster.jpeg",subfolder = "UMAP/CellCD_markers")
plot_umap(CellCD_filter,color_var = "annotation",plot_title="U-MAP all cells",legend_title = "Annotation",file_name="UMAP_CellCD_annotation.jpeg",subfolder = "UMAP/CellCD_markers")
plot_umap(CellCD_filter,color_var = "ExpGroup",plot_title="U-MAP all cells",legend_title = "Group",file_name="UMAP_CellCD_group.jpeg",subfolder = "UMAP/CellCD_markers")


# # myloid_fib+neu
# MacDendFibNeuCD_filter<-MacDendFibNeuCD
# MacDendFibNeuCD_filter= MacDendFibNeuCD_filter[MacDendFibNeuCD_filter$umap1<20,]
# MacDendFibNeuCD_filter= MacDendFibNeuCD_filter[MacDendFibNeuCD_filter$umap2<20,]
# MacDendFibNeuCD_filter= MacDendFibNeuCD_filter[MacDendFibNeuCD_filter$umap2>-10,]
# plot_umap(MacDendFibNeuCD_filter,color_var = "anncluster",plot_title="U-MAP MacDendFibNeuCD cells",legend_title = "Clusters",file_name="UMAP_MacDendFibNeuCD_cluster.jpeg",subfolder = "UMAP/MacDendFibNeuCD_markers")
# plot_umap(MacDendFibNeuCD_filter,color_var = "annotation",plot_title="U-MAP MacDendFibNeuCD cells",legend_title = "Annotation",file_name="UMAP_MacDendFibNeuCD_annotation.jpeg",subfolder = "UMAP/MacDendFibNeuCD_markers")
# plot_umap(MacDendFibNeuCD_filter,color_var = "ExpGroup",plot_title="U-MAP MacDendFibNeuCD cells",legend_title = "Group",file_name="UMAP_MacDendFibNeuCD_group.jpeg",subfolder = "UMAP/MacDendFibNeuCD_markers")


```


# xiaofei plot marker expression on Umap
```{r new UMAPs}
for (i in TCellMarkers){
  marker = str_remove(i, "MI_")
  p = ggplot(TCD,
             aes(x=umap1, y=umap2, colour = get(i))) + 
    geom_point(size = 0.3) + ggtitle(paste0("T cell ", marker, " expression")) + 
    theme_classic() + labs(x = "UMAP 1", y = "UMAP 2") +
    theme(plot.background = element_blank(),
          axis.title = element_text(size = 15),
          legend.text = element_text(size = 15),
          legend.title = element_blank(),
          plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
          panel.grid = element_blank(),
          #axis.text = element_blank(),
          axis.ticks = element_blank()) +
    scale_color_distiller(palette = "Spectral", limits = c(0,2))
  ggsave(filename = paste0("UMAP_T_cell_", marker, "_expression.jpeg"),
         path = file.path(OUTPUT_PATH, "UMAP/T_Cell_markers"), bg = "white",
         width = 2100, height = 1700, units = "px")
  print(p)
}
##MacDend markers
for (i in MacDendCellColumns){
  marker = str_remove(i, "MI_")
  p = ggplot(MacDendCD_filter,
             aes(x=umap1, y=umap2, colour = get(i))) + 
    geom_point(size = 0.3) + ggtitle(paste0("MacDend cell ", marker, " expression")) + 
    theme_classic() + labs(x = "UMAP 1", y = "UMAP 2") +
    theme(plot.background = element_blank(),
          axis.title = element_text(size = 15),
          legend.text = element_text(size = 15),
          legend.title = element_blank(),
          plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
          panel.grid = element_blank(),
          #axis.text = element_blank(),
          axis.ticks = element_blank()) +
    scale_color_distiller(palette = "Spectral", limits = c(0,2))
  ggsave(filename = paste0("UMAP_MacDend_cell_", marker, "_expression.jpeg"),
         path = file.path(OUTPUT_PATH, "UMAP/MacDendCD_markers"), bg = "white",
         width = 2100, height = 1700, units = "px")
  print(p)
}
#macdendtum
for (i in MacDendTumCellColumns){
  marker = str_remove(i, "MI_")
  p = ggplot(MacDendTumCD_filter,
             aes(x=umap1, y=umap2, colour = get(i))) + 
    geom_point(size = 0.3) + ggtitle(paste0("MacDendTum cell ", marker, " expression")) + 
    theme_classic() + labs(x = "UMAP 1", y = "UMAP 2") +
    theme(plot.background = element_blank(),
          axis.title = element_text(size = 15),
          legend.text = element_text(size = 15),
          legend.title = element_blank(),
          plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
          panel.grid = element_blank(),
          #axis.text = element_blank(),
          axis.ticks = element_blank()) +
    scale_color_distiller(palette = "Spectral", limits = c(0,2))
  ggsave(filename = paste0("UMAP_MacDendTum_cell_", marker, "_expression.jpeg"),
         path = file.path(OUTPUT_PATH, "UMAP/MacDendTumCD_markers"), bg = "white",
         width = 2100, height = 1700, units = "px")
  print(p)
}

##MAc Dend Neu Mono
for (i in MacDendNeuMonoCellColumns){
  marker = str_remove(i, "MI_")
  p = ggplot(MacDendNeuMonoCD_filter,
             aes(x=umap1, y=umap2, colour = get(i))) + 
    geom_point(size = 0.3) + ggtitle(paste0("MacDendNeuMono cell ", marker, " expression")) + 
    theme_classic() + labs(x = "UMAP 1", y = "UMAP 2") +
    theme(plot.background = element_blank(),
          axis.title = element_text(size = 15),
          legend.text = element_text(size = 15),
          legend.title = element_blank(),
          plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
          panel.grid = element_blank(),
          #axis.text = element_blank(),
          axis.ticks = element_blank()) +
    scale_color_distiller(palette = "Spectral", limits = c(0,2))
  ggsave(filename = paste0("UMAP_MacDendNeuMono_cell_", marker, "_expression.jpeg"),
         path = file.path(OUTPUT_PATH, "UMAP/MacDendNeuMonoCD_markers"), bg = "white",
         width = 2100, height = 1700, units = "px")
  print(p)
}
## tumor markers
for (i in TUMColumns){
  marker = str_remove(i, "MI_")
  p = ggplot(TUMCD,
             aes(x=umap1, y=umap2, colour = get(i))) + 
    geom_point(size = 0.3) + ggtitle(paste0("Tumour cell ", marker, " expression")) + 
    theme_classic() + labs(x = "UMAP 1", y = "UMAP 2") +
    theme(plot.background = element_blank(),
          axis.title = element_text(size = 15),
          legend.text = element_text(size = 15),
          legend.title = element_blank(),
          plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
          panel.grid = element_blank(),
          #axis.text = element_blank(),
          axis.ticks = element_blank()) +
    scale_color_distiller(palette = "Spectral", limits = c(0,2))
  ggsave(filename = paste0("UMAP_Tumour_cell_", marker, "_expression.jpeg"),
         path = file.path(OUTPUT_PATH, "UMAP/TUMCD_markers"), bg = "white",
         width = 2100, height = 1700, units = "px")
  print(p)
}
##plot MacDendFibTum marker  MacFibTumNeuCD
for (i in MacDendFibTumColumns){
  marker = str_remove(i, "MI_")
  p = ggplot(MacDendFibTumCD_filter,
             aes(x=umap1, y=umap2, colour = get(i))) + 
    geom_point(size = 0.3) + ggtitle(paste0("MacDendFibTumCD cell ", marker, " expression")) + 
    theme_classic() + labs(x = "UMAP 1", y = "UMAP 2") +
    theme(plot.background = element_blank(),
          axis.title = element_text(size = 15),
          legend.text = element_text(size = 15),
          legend.title = element_blank(),
          plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
          panel.grid = element_blank(),
          #axis.text = element_blank(),
          axis.ticks = element_blank()) +
    scale_color_distiller(palette = "Spectral", limits = c(0,2))
  ggsave(filename = paste0("UMAP_MacDendFibTumCD_cell_", marker, "_expression.jpeg"),
         path = file.path(OUTPUT_PATH, "UMAP/MacDendFibTumCD_markers"), bg = "white",
         width = 2100, height = 1700, units = "px")
  print(p)
}
for (i in TumourFibEndoEpiColumns){
  marker = str_remove(i, "MI_")
  p = ggplot(TumourFibEndoEpiCD_filter,
             aes(x=umap1, y=umap2, colour = get(i))) + 
    geom_point(size = 0.3) + ggtitle(paste0("TumourFibEndoEpiCD cell ", marker, " expression")) + 
    theme_classic() + labs(x = "UMAP 1", y = "UMAP 2") +
    theme(plot.background = element_blank(),
          axis.title = element_text(size = 15),
          legend.text = element_text(size = 15),
          legend.title = element_blank(),
          plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
          panel.grid = element_blank(),
          #axis.text = element_blank(),
          axis.ticks = element_blank()) +
    scale_color_distiller(palette = "Spectral", limits = c(0,2))
  ggsave(filename = paste0("UMAP_TumourFibEndoEpiCD_cell_", marker, "_expression.jpeg"),
         path = file.path(OUTPUT_PATH, "UMAP/TumourFibEndoEpiCD_markers"), bg = "white",
         width = 2100, height = 1700, units = "px")
  print(p)
}
for (i in CellColumns){
  marker = str_remove(i, "MI_")
  p = ggplot(CellCD_filter,
             aes(x=umap1, y=umap2, colour = get(i))) + 
    geom_point(size = 0.3) + ggtitle(paste0("CellCD cell ", marker, " expression")) + 
    theme_classic() + labs(x = "UMAP 1", y = "UMAP 2") +
    theme(plot.background = element_blank(),
          axis.title = element_text(size = 15),
          legend.text = element_text(size = 15),
          legend.title = element_blank(),
          plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
          panel.grid = element_blank(),
          #axis.text = element_blank(),
          axis.ticks = element_blank()) +
    scale_color_distiller(palette = "Spectral", limits = c(0,2))
  ggsave(filename = paste0("UMAP_CellCD_cell_", marker, "_expression.jpeg"),
         path = file.path(OUTPUT_PATH, "UMAP/CellCD_markers"), bg = "white",
         width = 2100, height = 1700, units = "px")
  print(p)
}



```
```{r}
#umap checking threshold
TUMCD$color <- ifelse(TUMCD$MI_EPCAM > 0.1, "black", "other")
TUMCD$color <- ifelse(TUMCD$MI_PancK > 0.2, "black", "other")
ggplot(TUMCD,
       aes(x = umap1, y = umap2, colour = color)) +
  geom_point(size = 0.3) + 
  ggtitle("U-MAP TUMCD cells") + 
  guides(colour = guide_legend(override.aes = list(size = 5), title = "Cluster")) +
  theme_classic() + 
  labs(x = "UMAP 1", y = "UMAP 2") +
  theme(plot.background = element_blank(),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 17, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
        panel.grid = element_blank(),
        axis.ticks = element_blank()) +
  scale_color_manual(values = c("black" = "black", "other" = "grey"))
## F480
MacDendNeuMonoCD_filter$color <- ifelse(MacDendNeuMonoCD_filter$MI_F480 > 0.25, "black", "other")
ggplot(MacDendNeuMonoCD_filter,
       aes(x = umap1, y = umap2, colour = color)) +
  geom_point(size = 0.3) + 
  ggtitle("U-MAP MacDendNeuMonoCD_filter F480") + 
  guides(colour = guide_legend(override.aes = list(size = 5), title = "Cluster")) +
  theme_classic() + 
  labs(x = "UMAP 1", y = "UMAP 2") +
  theme(plot.background = element_blank(),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 17, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
        panel.grid = element_blank(),
        axis.ticks = element_blank()) +
  scale_color_manual(values = c("black" = "black", "other" = "grey"))
#CD11c
MacDendNeuMonoCD_filter$color <- ifelse(MacDendNeuMonoCD_filter$MI_CD11c > 0.25, "black", "other")
ggplot(MacDendNeuMonoCD_filter,
       aes(x = umap1, y = umap2, colour = color)) +
  geom_point(size = 0.3) + 
  ggtitle("U-MAP MacDendNeuMonoCD_filter_CD11c ") + 
  guides(colour = guide_legend(override.aes = list(size = 5), title = "Cluster")) +
  theme_classic() + 
  labs(x = "UMAP 1", y = "UMAP 2") +
  theme(plot.background = element_blank(),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 17, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
        panel.grid = element_blank(),
        axis.ticks = element_blank()) +
  scale_color_manual(values = c("black" = "black", "other" = "grey"))
#MHCII
MacDendNeuMonoCD_filter$color <- ifelse(MacDendNeuMonoCD_filter$MI_MHCII > 0.2, "black", "other")
ggplot(MacDendNeuMonoCD_filter,
       aes(x = umap1, y = umap2, colour = color)) +
  geom_point(size = 0.3) + 
  ggtitle("U-MAP MacDendNeuMonoCD_filter_MHCII ") + 
  guides(colour = guide_legend(override.aes = list(size = 5), title = "Cluster")) +
  theme_classic() + 
  labs(x = "UMAP 1", y = "UMAP 2") +
  theme(plot.background = element_blank(),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 17, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
        panel.grid = element_blank(),
        axis.ticks = element_blank()) +
  scale_color_manual(values = c("black" = "black", "other" = "grey"))
#Ly6G
MacDendNeuMonoCD_filter$color <- ifelse(MacDendNeuMonoCD_filter$MI_LY6G > 0.3, "black", "other")
ggplot(MacDendNeuMonoCD_filter,
       aes(x = umap1, y = umap2, colour = color)) +
  geom_point(size = 0.3) + 
  ggtitle("U-MAP MacDendNeuMonoCD_filter_LY6G ") + 
  guides(colour = guide_legend(override.aes = list(size = 5), title = "Cluster")) +
  theme_classic() + 
  labs(x = "UMAP 1", y = "UMAP 2") +
  theme(plot.background = element_blank(),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 17, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
        panel.grid = element_blank(),
        axis.ticks = element_blank()) +
  scale_color_manual(values = c("black" = "black", "other" = "grey"))
#F480


MacDendNeuMonoCD_filter <- MacDendNeuMonoCD_filter %>%
  mutate(color = case_when(
    MI_CD11b > 0.25 ~ "green",
    MI_LY6G > 0.2 ~ "red", 
    k20 == "21" ~ "yellow",  
    TRUE ~ "other"  
  )) %>%
  arrange(color == "other", color == "yellow", color == "red",color == "green")  

ggplot(MacDendNeuMonoCD_filter,
       aes(x = umap1, y = umap2, colour = color)) +
  geom_point(size = 0.3) + 
  ggtitle("U-MAP MacDendNeuMonoCD_filter_F480 ") + 
  guides(colour = guide_legend(override.aes = list(size = 5), title = "Cluster")) +
  theme_classic() + 
  labs(x = "UMAP 1", y = "UMAP 2") +
  theme(plot.background = element_blank(),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 17, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
        panel.grid = element_blank(),
        axis.ticks = element_blank()) +
scale_color_manual(
  values = c("red" = "red", "yellow" = "yellow", "green" = "green", "other" = "grey"),
  labels = c("red" = "MI_LY6G > 0.2", 
             "green" = "MI_CD11b > 0.25", 
             "yellow" = "k20 == 21", 
             "other" = "Other")
)
#Ly6g
MacDendNeuMonoCD_filter$color <- ifelse(MacDendNeuMonoCD_filter$MI_LY6G > 0.2, "black", "other")
ggplot(MacDendNeuMonoCD_filter,
       aes(x = umap1, y = umap2, colour = color)) +
  geom_point(size = 0.3) + 
  ggtitle("U-MAP MacDendNeuMonoCD_filter_Ly6G ") + 
  guides(colour = guide_legend(override.aes = list(size = 5), title = "Cluster")) +
  theme_classic() + 
  labs(x = "UMAP 1", y = "UMAP 2") +
  theme(plot.background = element_blank(),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 17, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
        panel.grid = element_blank(),
        axis.ticks = element_blank()) +
  scale_color_manual(values = c("black" = "black", "other" = "grey"),labels=c("black"="MI_Ly6G>0.2","grey"="other"))

#Ly6g
MacDendNeuMonoCD_filter$color <- ifelse(MacDendNeuMonoCD_filter$MI_LY6G > 0.3, "black", "other")
ggplot(MacDendNeuMonoCD_filter,
       aes(x = umap1, y = umap2, colour = color)) +
  geom_point(size = 0.3) + 
  ggtitle("U-MAP MacDendNeuMonoCD_filter_Ly6G ") + 
  guides(colour = guide_legend(override.aes = list(size = 5), title = "Cluster")) +
  theme_classic() + 
  labs(x = "UMAP 1", y = "UMAP 2") +
  theme(plot.background = element_blank(),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 17, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
        panel.grid = element_blank(),
        axis.ticks = element_blank()) +
  scale_color_manual(values = c("black" = "black", "other" = "grey"),labels=c("black"="MI_Ly6G>0.3","grey"="other"))

#CD103
MacDendNeuMonoCD_filter$color <- ifelse(MacDendNeuMonoCD_filter$MI_CD103> 1.5, "black", "other")
ggplot(MacDendNeuMonoCD_filter,
       aes(x = umap1, y = umap2, colour = color)) +
  geom_point(size = 0.3) + 
  ggtitle("U-MAP MacDendNeuMonoCD_filter_CD103 ") + 
  guides(colour = guide_legend(override.aes = list(size = 5), title = "Cluster")) +
  theme_classic() + 
  labs(x = "UMAP 1", y = "UMAP 2") +
  theme(plot.background = element_blank(),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 17, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
        panel.grid = element_blank(),
        axis.ticks = element_blank()) +
  scale_color_manual(values = c("black" = "black", "other" = "grey"),labels=c("black"="MI_CD103> 1.5","grey"="other"))



# TREGS IN TCellcd
CellCD_filter$color <- ifelse(CellCD_filter$MI_CD103>2, "black", "other")
ggplot(CellCD_filter,
       aes(x = umap1, y = umap2, colour = color)) +
  geom_point(size = 0.3) + 
  ggtitle("CellCD_cluster32 ") + 
  guides(colour = guide_legend(override.aes = list(size = 5), title = "Cluster")) +
  theme_classic() + 
  labs(x = "UMAP 1", y = "UMAP 2") +
  theme(plot.background = element_blank(),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 17, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
        panel.grid = element_blank(),
        axis.ticks = element_blank()) +
  scale_color_manual(values = c("black" = "black", "other" = "grey"))

```


#check if extrame value not cleaned in normalization
```{r}
#check the mean and sd 
summary_data <- celldata %>%
  select(where(is.numeric)) %>%
  summarise(across(everything(), list(mean = mean, sd = sd)))

high_sd_markers <- summary_data %>%
  select(ends_with("sd")) %>%
  filter(if_any(starts_with("MI_"), ~ . > 3)) 
print(high_sd_markers)

# 计算 CD103 的 Z-score
zscore_cd103 <- scale(celldata$MI_CD103)

# 标记 Z-score > 3 或 < -3 的异常值
abnormal_cd103 <- which(abs(zscore_cd103) > 3)

# 查看异常值所在的行
celldata[abnormal_cd103, ]
# 绘制 MI_CD103 的箱型图
boxplot(celldata$MI_CD103, 
        main = "Boxplot of MI_CD103 with Abnormal Values",  
        ylab = "MI_CD103 Expression",                       
        col = "lightblue",                                   
        border = "black")                                    
boxplot(celldata$MI_CD68, 
        main = "Boxplot of MI_CD68 with Abnormal Values",  
        ylab = "MI_CD103 Expression",                       
        col = "lightblue",                                   
        border = "black")    



# check the z score   doesnt work  here 
numeric_data <- celldata %>% select(where(is.numeric))
z_scores <- as.data.frame(scale(numeric_data))
outlier_matrix <- abs(z_scores) > 10 
outlier_markers <- apply(outlier_matrix, 1, function(row) {
  paste(names(row)[row], collapse = ", ")  
})
celldata$Outlier_Markers <- outlier_markers  
celldata$Outlier <- apply(outlier_matrix, 1, any)  
outlier_cells <- celldata %>% filter(Outlier == TRUE)
outlier_table <- outlier_cells[, c("cell_ID", "Outlier_Markers")]
print(outlier_table)



```




#ggplot checking
# plot dots on all original image or on specific image for checking the cutoff

```{r}
# CD206,CD80 CD86 CD44 CD24_Tumour MHCII Ki67 LAG3 MHCII PD1 PDL1   TIM3   Thy1.2  casp3 pS6  PVR 

#plot.scatter(celldata, "kinv25", 4, "CD11c", "MHCcII",dim=1)
#plot.scatter(celldata, cluster = "kinv40", clusterN = c(16), Xmarker = "EpCAM", Ymarker = "aSMA",dim=1)
ggplot(celldata, aes(x= Location_Center_X, y = -Location_Center_Y)) +
  geom_point(data=celldata,size = 0.01, color = "black") +
   #geom_point(data = celldata[which(celldata$annotation=="Tumour"),], size = 0.01, colour = "yellow") +
  #geom_point(data = celldata[which(celldata$anncluster=="01A_Macrophages F480"),], size = 0.01, colour = "yellow") +
   # geom_point(data = celldata[which(celldata$kinv25=="27"),], size = 0.01, colour = "yellow") +
     # geom_point(data = celldata[which(celldata$kinv25=="28"),], size = 0.01, colour = "green") +
 #geom_point(data = celldata[which(celldata$kinv25=="17"&celldata$MI_CD11c>1&celldata$MI_MHCcII>1),], size = 0.01, colour = "red") +
  #geom_point(data = celldata[which(celldata$MI_B220>0.3),], size = 0.01, colour = "red") +
  # geom_point(data = celldata[which(celldata$MI_B220>0.3&celldata$MI_CollagenI>0.5),], size = 0.01, colour = "yellow") +
#geom_point(data = celldata[which(celldata$MI_Foxp3>0.5),], size = 0.01, colour = "red") +
 geom_point(data = celldata[which(celldata$k20=="17"&celldata$MI_CD103>3),], size = 0.01, colour = "red") +
  theme_classic() +
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        panel.background=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        strip.text = element_text(size = 8),
        strip.background = element_rect(),
        panel.spacing = unit(0, "mm"),
        plot.background = element_blank())+
  facet_wrap(~name,nrow=3)
```
##plot dots on one specific original image
```{r}
#lag3 0.5PVR 0.25 almost all 0.3 clealy less MHCII   0.25 PDL1  0.15 CD24  0.2 PS6 0.2  Casp 0.3 colleagen
ROI13<-subset(celldata, ROI_ID == "10_WT") #  "01_CCR2KO" "02_CCR2KO" "03_CCR2KO" "04_CCR2KO" "05_CCR2KO" "06_CCR2KO" "07_WT"     "08_WT"     "09_WT"     "10_WT"     "11_WT"     "12_WT"   
ggplot(ROI13, aes(x= Location_Center_X, y = -Location_Center_Y)) +
  #ggplot(celldata, aes(x= Location_Center_X, y = -Location_Center_Y)) +
  geom_point(size = 0.5, color = "black") +
    #geom_point(data = ROI13[which(ROI13$annotation=="B cells"),], size = 0.1, colour = "red")+
  #geom_point(data = ROI13[which(ROI13$annotation=="B cells"&ROI13$MI_CollagenI>0.5),], size = 0.1, colour = "yellow")+
   
 geom_point(data = ROI13[which(ROI13$k20=="21"&ROI13$MI_LY6G>0.4),], size = 0.5, colour = "yellow") +
 geom_point(data = ROI13[which(ROI13$k20=="21"&ROI13$MI_LY6G<0.4),], size = 0.5, colour = "red") +

  theme_classic() +
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        panel.background=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        strip.text = element_text(size = 8),
        strip.background = element_rect(),
        panel.spacing = unit(0, "mm"),
        plot.background = element_blank())+
  facet_wrap(~ROI_ID,nrow=1)


```






# plot annotation or anncluster to TSNE
```{r}
columns_to_add <- c("anncluster","annotation","cell_type","cell_ID")
celldata_subsample <- left_join(x = celldata_subsample, y = celldata[,columns_to_add], 
                     by = "cell_ID")
plot.tSNE(celldata_subsample, c("tSNE1", "tSNE2"), "annotation", savetSNE = F,
          title = "annotation", labelClusters = T)
plot.tSNE(celldata_subsample, c("tSNE1", "tSNE2"), "anncluster", savetSNE = F,
          title = "ancluster", labelClusters = T)
plot.tSNE(celldata_subsample, c("tSNE1", "tSNE2"), "cell_type", savetSNE = F,
          title = "cell_type", labelClusters = T)
```
```{r}
date<- format(Sys.Date(), "%y%m%d")
output_file = paste0(OUTPUT_PATH,"/", date, "_celldata.csv")#OUTPUT_PATH
output_file
write.csv(celldata, file = output_file, row.names = F) 



```
## Barplot celltype percentage

Create a barplot displaying the percentage of each celltypes to the total
amount of cells in one experimental group.

```{r stacked barplot function}
# celldata<-read.csv("/mnt/Data1/groupfebe/runs/Xiaofei/240920_Sahai_CCR2_IMC/Projectfile/Data/Figures_input/241103_celldata.csv")
# celldata$ExpGroup[celldata$ExpGroup=="MOC2_WT"]<-"WT"
# celldata$ExpGroup[celldata$ExpGroup=="MOC2_CCR2KO"]<-"CCR2KO"
unique(celldata$ExpGroup)
create.resultsdir <- function(path, name) {
  dir_path <- file.path(path, name)
  if (!dir.exists(dir_path)) {
    dir.create(dir_path, recursive = TRUE)
    message("Directory created: ", dir_path)
  } else {
    message("Directory already exists: ", dir_path)
  }
  return(dir_path)
}
str(celldata)
#celldata[, c("ExpGroup", "ROI_ID","annotation","anncluster","cell_type")] <- lapply(df[, c("ss", "aa")], as.factor)
celldata <- celldata %>%
  mutate(across(c("ExpGroup","annotation","anncluster"), as.factor))
str(celldata)
plot.celltypeperc = function(celldata, title) {
  date = str_sub(gsub("-", "", Sys.Date()), -6, -1)
  directory = create.resultsdir(path = OUTPUT_PATH, name = "Stacked_barplots")
  filename = paste0(title, ".jpeg")
  p = ggplot(celldata, 
             aes(x = factor(ExpGroup, levels = unique(ExpGroup)),
                 fill = factor(annotation, levels = unique(annotation)))) +
    geom_bar(position = "fill", colour = "black") +
    scale_fill_manual(values = colours) +
    scale_y_continuous(labels = scales::percent) +
    scale_x_discrete(limits=c("WT","CCR2KO")) +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 60, size =14, hjust = 1), 
          axis.text.y = element_text(size =14),
          plot.title = element_text(size = 6), 
          legend.title = element_blank(),
          legend.text = element_text(size = 14),
          axis.title=element_blank())
  
  filename = paste0(date, "_", title, ".jpeg")
  ggsave(device = "jpeg", width = 2000, height = 2000, units = "px", dpi = 300,
         path = directory, filename = filename)
  return(p)
}



# Match clusters ---------------------------------------------------------------
# Description : Returns the levels in celldata$anncluster that match with one
#               of the strings in patterns
# ---Parameters---
# patterns  --> [vector] a vector with strings that match with the desired clusters
# << Output >>  [vector] a vector with the names of the matched clusters
get.clusters = function(patterns) {
  clusters = sapply(X = patterns, FUN = grep, x = unique(celldata$anncluster), value = T)
  clusters = unlist(clusters, use.names = F)
  
  return(clusters)
}

# Get matched colours ----------------------------------------------------------
# Description : Returns a named vector with colours for each name in 'levels'
# ---Parameters---
# levels  --> [vector] a vector with names to which colours should be assigned
# << Output >>  [vector] a named vector of colours where names equals 'levels'
matchColours = function(levels) {
  colours = hue_pal()(length(levels))
  colours = setNames(colours, levels)
  return(colours)
}
# ## checking is there factor missing 

#colours
colours =  c("B cells" = "#945931",  "Dendritic cells" = "#FF9933", "Dendritic cells CD103" = "#FFCC66", "Endothelium" = "#FFEA42",
              "Epithelium" = "#FFF4A4FF", "Fibroblasts" = "#ABDDA4FF",  "TCRgdt" = "#336666","Macrophages" = "#4E79A7FF",
              "Macrophages F480" = "#4E79A7FF", "Macrophages CD68" = "#5F9EA0", "Macrophages CD11b" = "#0072B2", "Neutrophils" = "#A0CBE8FF",  "T cell CD4" = "#B07AA1FF","Monocytes"= "#40E0D0",  "T cell CD8" = "#FF9D9AFF", "Tregs" = "#CC6666", "Tumour" = "#704850FF", "Uncertain" = "#8C8C8C")
# "Fibroblasts Thy1.2" = "#74a892", cluster_cols = c( "#FFF4A4FF",  "#ABDDA4FF", "#618F75FF",  "#336666","Dendritic cells CD11c-" = "#FF6347"
#                "#4E79A7FF", "#A0CBE8FF","#938ABBFF",  "#B07AA1FF",
#                "#FF9D9AFF", "#CC6666",  "#704850FF",  "#8C8C8C", "#FFD700",   "#00FF7F",   "#8B4513",  "#FF6347",  "#40E0D0",   "#7FFF00",
#   "#DC143C", "#8B0000","#F0E442", "#0072B2", "#D55E00", "#CC79A7", 'red','pink','purple','blue',"#8FBC8B", "#6A5ACD", "#4682B4", "#FF4500", "#2E8B57",
# "#483D8B", "#FF1493", "#FF8C00", "#98FB98", "#556B2F",
# "#CD5C5C", "#00008B", "#FFDAB9", "#BA55D3", "#87CEEB",
# "#B0E0E6", "#5F9EA0")
#"Macrophages F480" = "#d6e6ff", "Macrophages CD11c" = "#e5d4ef", 
####### per treatment group--percentage 

plot.celltypeperc(celldata = celldata,title = "Stacked_metaclusters")
plot.celltypeperc(celldata = celldata[!celldata$annotation %in% c("Tumour", "Uncertain"),],
                  title = "Stacked_without_tumour")
plot.celltypeperc(celldata = celldata[!celldata$annotation %in% c("Tumour",  "Fibroblasts", "Endothelium","Uncertain"),],
                  title = "Stacked_immune_cells")
## not work
plot.celltypeperc = function(celldata, title) {
  date = str_sub(gsub("-", "", Sys.Date()), -6, -1)
  directory = create.resultsdir(path = OUTPUT_PATH, name = "Stacked_barplots")
  filename = paste0(title, ".jpeg")
  p = ggplot(celldata, 
             aes(x = factor(ExpGroup, levels = unique(ExpGroup)),
                 fill = factor(anncluster, levels = unique(anncluster)))) +
    geom_bar(position = "fill", colour = "black") +
    scale_fill_manual(values = colours) +
    scale_y_continuous(labels = scales::percent) +
    scale_x_discrete(limits=c("WT","CCR2KO")) +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 60, size =14, hjust = 1), 
          axis.text.y = element_text(size =14),
          plot.title = element_text(size = 6), 
          legend.title = element_blank(),
          legend.text = element_text(size = 14),
          axis.title=element_blank())
  
  filename = paste0(date, "_", title, ".jpeg")
  ggsave(device = "jpeg", width = 2000, height = 2000, units = "px", dpi = 300,
         path = directory, filename = filename)
  return(p)
}
plot.celltypeperc(celldata = celldata,title = "Stacked_metaclusters")
plot.celltypeperc(celldata = celldata[!celldata$annotation %in% c("Tumour", "Uncertain"),],
                  title = "Stacked_without_tumour")
plot.celltypeperc(celldata = celldata[!celldata$annotation %in% c("Tumour",  "Fibroblasts Thy1.2", "Fibroblasts aSMA", "Endothelium", "Epithelium","Uncertain"),],
                  title = "Stacked_immune_cells")
```
# save plotstack image 
```{r}

levels2 = c("T cell CD4", "T cell CD8", "Tregs","B cells", "Neutrophils", "Macrophages", "Monocytes", "Dendritic cells","Dendritic cells CD103", "Endothelium","Epithelium", "Fibroblasts","Tumour","Uncertain")
plot.celltypeperc = function(celldata, title) {
  date = str_sub(gsub("-", "", Sys.Date()), -6, -1)
  #Proportion of cell types in tumour domain
  p = ggplot(celldata, 
             aes(x = factor(ExpGroup, levels = unique(ExpGroup)),
                 fill = factor(annotation, levels = levels2))) +
    geom_bar(position = "fill", colour = "black") +
    scale_y_continuous(labels = scales::percent) +
    scale_x_discrete(limits=c("WT","CCR2KO")) +
     scale_fill_manual(values = colours) +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 60, size =14, hjust = 1), 
          axis.text.y = element_text(size =14),
          plot.title = element_text(size = 6), 
          legend.title = element_blank(),
          legend.text = element_text(size = 14),
          axis.title=element_blank())
  
  filename = paste0(date, "_", title, ".jpeg")
  ggsave(plot = p, device = "jpeg", width = 2000, height=2000, units = "px", dpi=300,
         path = file.path(OUTPUT_PATH, "StackBarplot/"), filename = filename)
  return(p)
}

plot.celltypeperc(celldata = celldata, title = "Stacked_metaclusters")

plot.celltypeperc(celldata = celldata[!celldata$annotation %in% c("Tumour", "Uncertain"),],
                  title = "Stacked_without_tumour")
plot.celltypeperc(celldata = celldata[!celldata$annotation %in% c("Tumour", "Epithelium", "Fibroblasts", "Endothelium","Uncertain","Epithelium"),],
                  title = "Stacked_immune_cells_annotation")


plot.celltypeperc2 = function(celldata, title) {
  date = str_sub(gsub("-", "", Sys.Date()), -6, -1)
   
p = ggplot(celldata, 
             aes(x = factor(ExpGroup, levels = unique(ExpGroup)),
                 fill = factor(cell_type, levels = levels2))) +
    geom_bar(position = "fill", colour = "black") +
    scale_y_continuous(labels = scales::percent) +
     scale_fill_manual(values = colours) +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 60, size =14, hjust = 1), 
          axis.text.y = element_text(size =14),
          plot.title = element_text(size = 6), 
          legend.title = element_blank(),
          legend.text = element_text(size = 14),
          axis.title=element_blank())
  
  filename = paste0(date, "_", title, ".jpeg")
  ggsave(plot = p, device = "jpeg", width = 2000, height=2000, units = "px", dpi=300,
         path = file.path(output_path, "StackBarplot/"), filename = filename)
  return(p)
}
plot.celltypeperc2(celldata = celldata[!celldata$cell_type%in% c("Tumour", "Epithelium", "Fibroblasts", "Endothelium"),],
                  title = "Stacked_immune_cells_celltype")
plot.celltypeperc2(celldata = celldata, title = "Stacked_metaclusters")
# 
plot.celltypeperc3 = function(celldata, title) {
  date = str_sub(gsub("-", "", Sys.Date()), -6, -1)
   
p = ggplot(celldata, 
             aes(x = factor(ROI_ID, levels = unique(ROI_ID)),
                 fill = factor(annotation, levels = levels1))) +
    geom_bar(position = "fill", colour = "black") +
    scale_y_continuous(labels = scales::percent) +
     scale_fill_manual(values = colours1) +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 60, size =14, hjust = 1), 
          axis.text.y = element_text(size =14),
          plot.title = element_text(size = 6), 
          legend.title = element_blank(),
          legend.text = element_text(size = 14),
          axis.title=element_blank())
  
  filename = paste0(date, "_", title, ".jpeg")
  ggsave(plot = p, device = "jpeg", width = 2000, height=2000, units = "px", dpi=300,
         path = file.path(output_path, "StackBarplot/"), filename = filename)
  return(p)
}
plot.celltypeperc3(celldata = celldata_macrophages,title = "Stacked_macrophages_ROI")
plot.celltypeperc3(celldata = celldata_macrophages,title = "Stacked_macrophages_ROI")
#cell type


```






