---
title: "250108 tSNE and annotation relative"
author: "Xiaofei YU"
date: "2025-01-08"
output: 
html_document:
    theme:
      spacelab
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
    number_sections: false
    highlight: textmate 
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(gplots)
library(pheatmap)
library(Rtsne)
library(ggplot2)
library(dplyr)
library(RColorBrewer)
library(stringr)
library(gridExtra)
library(RColorBrewer)
library(ggridges)
library(ggpubr)
library(scales)
library(clustree)
library(cowplot)
library(umap)
library(rlang)
```

#load data
```{r global-variables, include=TRUE, results=FALSE}
# Path for loading data and saving results 
# Project folder path:
BASE = "/mnt/Data1/groupfebe/runs/Xiaofei/CCR2_LUNG"

# Name of input and output directories:
INPUT_PATH = file.path(BASE, "Data/Annotation_input")
OUTPUT_PATH = file.path(BASE, "Results/Annotation_output/")

# Load celldata excluding tSNE coordinates  /load sampled celldata with tSNE coordinates. 
celldata = read.csv(paste0(INPUT_PATH, "/250107_normalised_concatenated_scaled_data_001threshold.csv"))
celldata_subsample = read.csv(paste0(INPUT_PATH,"/250107_celldata_subsamples.csv"))

# Add clustering and t-SNE columns to datafiles
# tSNEcsv is sampledtSNE 
tSNECSV = read.csv(file.path(INPUT_PATH, "250107_tSNE_subsamples.csv"))
clustCSV = read.csv(file.path(INPUT_PATH, "250108_clustering_k30_k25_k20_k15_19markers.csv"))
celldata = cbind(celldata, clustCSV)
# Load in the image metadata
imagemetadata = read.csv(file.path(INPUT_PATH, "imagemetadata.csv"))
# Due to the computer is not powerful enough ,so I only get sampled tSNE here. celldata_subsample is using for making plots which includes tSNE coordinates.
celldata_subsample = cbind(celldata_subsample, tSNECSV)
##celldata with part tSNE coordinates "NA" but i dont need using tSNE coordinate for heatmap
columns_to_add <- c("cell_ID","tSNE1", "tSNE2")
celldata <- left_join(x = celldata, y = celldata_subsample[,columns_to_add], 
                     by = "cell_ID")

celldata <- celldata %>%
  mutate(name = paste(ROI_ID, filename, sep = "_"))
unique(celldata$name)


create.resultsdir <- function(path, name) {
  dir_path <- file.path(path, name)
  if (!dir.exists(dir_path)) {
    dir.create(dir_path, recursive = TRUE)
    message("Directory created: ", dir_path)
  } else {
    message("Directory already exists: ", dir_path)
  }
  return(dir_path)
}

date = str_sub(gsub("-", "", Sys.Date()), -6, -1)
# Load in UMAP dataframes-- need to make umap after annotation [cycle]
#TCD = read.csv(file.path(INPUT_PATH, "TCD.csv"))
#MacDendCD = read.csv(file.path(INPUT_PATH, "MacDendCD.csv"))
#FibEndoCD = read.csv(file.path(INPUT_PATH, "FibEndoCD.csv"))
#MyeloidCD = read.csv(file.path(INPUT_PATH, "MyeloidCD.csv"))
```
###########   Reload data, not from begainning  (minues annotation .exp.)
```{r}
# Project folder path:
BASE = "/mnt/Data1/groupfebe/runs/Xiaofei/240920_Sahai_CCR2_IMC"

# Name of input and output directories:
INPUT_PATH = file.path(BASE, "Projectfile/Data/Figures_input")
OUTPUT_PATH = file.path(BASE, "Projectfile/Results/Figures_output/")
#input celldata 
celldata = read.csv(paste0(INPUT_PATH, "/241202_celldata.csv"))
CellCD = read.csv(paste0(INPUT_PATH, "/241101CellCD.csv"))
TCD = read.csv(paste0(INPUT_PATH, "/241101TCD.csv"))
TUMCD =read.csv(paste0(INPUT_PATH, "/241101TUMCD.csv"))
MacCD =read.csv(paste0(INPUT_PATH, "/241101MacCD.csv"))
MacDendCD =read.csv(paste0(INPUT_PATH, "/241101MacDendCD.csv"))
FibEndoCD =read.csv(paste0(INPUT_PATH, "/241101FibEndoCD.csv"))
MacFibTumNeuCD =read.csv(paste0(INPUT_PATH, "/241101MacDendFibTumNeuCD.csv"))
stat_241105_ROI = read.csv(paste0(INPUT_PATH, "/_stat_241105_ROI.csv"))
imagemetadata = read.csv(file.path(INPUT_PATH, "imagemetadata.csv"))

```



#set function for plot tSNE and heatmap
```{r global-variables, include=TRUE, results=FALSE}
# Make heatmap matrix-----------------------------------------------------------
# Description : Create a heatmap matrix that contains mean expression data per
#               marker per level of the given factor. Rows in this matrix are
#               markers in 'markerlist', columns are levels in 'factor'.
# ---Parameters---
# celldata    --> [dataframe] a dataframe with marker intensity data.
# markerlist  --> [vector] a vector with names of columns of celldata with
#                 marker expression data that should be included in the heatmap.
# factor      --> [string] the name of a column of celldata that acts as a factor.
# << Output >>    [image] A dataframe with the mean marker expression for each
#                 marker in markerlist for all the levels in factor.

##  get cluster center from clusting results
get.cluster.centers = function(celldata, tSNEaxes, clustering){
  celldata = celldata[!is.na(celldata[,clustering]),]
  clusterCenters = data.frame()
  for (cl in unique(celldata[,clustering])){
    x = median(celldata[,tSNEaxes[1]][which(celldata[,clustering] == cl)])
    y = median(celldata[,tSNEaxes[2]][which(celldata[,clustering] == cl)])
    clusterCenters[cl, "cl"] = cl
    clusterCenters[cl, "x"] = x
    clusterCenters[cl, "y"] = y
  }
  return(clusterCenters)
}



make.heatmap.matrix = function(celldata, markerlist, cluster){
  heatmap_df = data.frame()
  
  # Leave out unclustered cells (cluster == NA)
  celldata = celldata[!is.na(celldata[,cluster]),]

  for (cl in unique(celldata[,cluster])){
    md = celldata[celldata[,cluster] == cl,]
    for (marker in markerlist){
      heatmap_df[cl, marker] =  mean(md[,paste("MI_", marker, sep = "")])
      heatmap_df[cl, "clustername"] = cl
    }
  }
  
  row.names(heatmap_df) = heatmap_df$clustername
  heatmap_df = t(as.matrix(subset(heatmap_df, select = -clustername)))
  
  return(heatmap_df)
}



plot.heatmap2 = function(celldata, markerlist, cluster, scale="column", title,
                         margins=c(4,5), srtCol=0, Rowv=NULL, Colv=NULL,
                         barplot = c(), type = "stack", transpose = F
){
  matrix = make.heatmap.matrix(celldata, markerlist, cluster)
  
  if (transpose) {matrix = t(matrix)}
  
  hm = heatmap.2(matrix,
                 dendrogram = "none", Rowv = Rowv, Colv = Colv, 
                 scale = scale, trace = "none", 
                 #col = colorRampPalette(brewer.pal(8, "Blues"))(25),
                col = colorRampPalette(c("blue","white","red"))(25),
                 
                 main = title, margins = margins,
                 cexRow = 1, cexCol = 1, srtCol = srtCol,
                 keysize = .8, density.info = "none", key.par=list(mar = c(4,0.5,2,0.7)),
                 lmat = matrix(data = c(0,0,0,4,1,1,3,1,1,2,2,2), ncol = 4),
                 lwid = c(.5, 1.8, 6.5, 0.01), lhei = c(2, 1.8, 5))
  
  if (length(barplot) != 0) {
    for (i in 1:length(barplot)) {
      df = as.data.frame(table(paste(celldata[!is.na(celldata[,cluster]), cluster],
                                     celldata[,barplot[i]], sep = "x_x")))
      df = cbind(str_split_fixed(df[,1], "x_x", n = 2), df[,2])
      df = data.frame(as.numeric(df[,1]), df[,2], as.numeric(df[,3]))
      colnames(df) = c("cluster", "ROI_ID", "Cell_count")
      df$cluster = factor(df$cluster, levels = hm$colInd)
      
      p = ggplot(df, aes(fill=ROI_ID, y=Cell_count, x=cluster)) + 
        geom_bar(position=type, stat="identity", orientation = "x") +
        ggtitle(paste0("Cell count by ", barplot[i])) + theme_classic() +
        theme(plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
              axis.text.x = element_text(angle = 90, vjust = .5),
              plot.margin = unit(c(0.02, 0, .03, 0), units = "npc"))
      print(p)
    }
  }
}

# Create a scatter plot --------------------------------------------------------
# Description : Plot cells in a scatterplot based on two markers ('Xmarker' and
#               'Ymarker') of which the mean intensity is plotted on the X and Y
#               axis respectively
# ---Parameters---
# celldata  --> [dataframe] a dataframe with mean intensity data by marker
# factor    --> [string] name of a column of 'dataframe' that acts as a factor
# levels    --> [vector] a vector with levels of factor; cells belonging to
#               one of these levels are included in the plot
# Xmarker   --> [string] name of a column with mean intensity data (X-axis)
# Ymarker   --> [string] name of a column with mean intensity data (Y-axis)
# title     --> [string ("")] name of the plot
# axisLim   --> [int (2)] upper limit of the axes
# << Output >>  [string] the path to the second created folder with name 'name'

plot.scatter = function(celldata, cluster, clusterN, Xmarker, Ymarker,
                        main = "", dim = 2, layout = "ghostvar") {
  # Select celldata of the selected clusters
  celldata = celldata[celldata[,cluster] %in% clusterN,]
  
  # Convert the markers into symbols to be used by ggplot
  x = sym(paste0("MI_", Xmarker))
  y = sym(paste0("MI_", Ymarker))
  
  # Set the nbin based on the celldata size
  nbin = ifelse(nrow(celldata)>200000, 1024, 
                ifelse(nrow(celldata)>20000, 512, 256))
  
  # Color by density
  colramp = colorRampPalette(rev(brewer.pal(n = 9, name = "YlGn")[3:9]))
  color = densCols(x = celldata[,paste0("MI_", Xmarker)],
                   y = celldata[,paste0("MI_", Ymarker)],
                   colramp = colramp, nbin = nbin)
  
  ggplot(data = celldata, aes(x = !!x, y = !!y)) +
    geom_point(shape = I(20), size = 1.5, aes(x = !!x, y = !!y, col = color)) +
    scale_x_continuous(limits = c(0,dim), expand = c(0,0),
                       oob = scales::squish) +
    scale_y_continuous(limits = c(0,dim), expand = c(0,0),
                       oob = scales::squish) + scale_color_identity() + 
    ggtitle(main) + ylab(Ymarker) + xlab(Xmarker) + theme_classic() + 
    theme(plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
          plot.margin = unit(c(0.05, 0, .05, 0), units = "npc"),
          axis.title = element_text(size = 8, face = "bold"),
          axis.text = element_text(size = 8, colour = "black"),
          panel.background = element_rect(fill = "grey95"), aspect.ratio = 1)
}

# Create a heated scatter plot -------------------------------------------------
# Description : Plot cells in a scatterplot based on three markers ('Xmarker',
#               'Ymarker' and 'colorMarker') of which the mean intensity of the
#               first two is plotted on the X and Y axis, and the third marker
#               is represented as colourgradient of the plotted datapoints.
# ---Parameters---
# celldata    --> [dataframe] a dataframe with mean intensity data by marker
# factor      --> [string] name of a column of 'dataframe' that acts as a factor
# levels      --> [vector] a vector with levels of factor; cells belonging to
#                 one of these levels are included in the plot
# Xmarker     --> [string] name of a column with mean intensity data (X-axis)
# Ymarker     --> [string] name of a column with mean intensity data (Y-axis)
# colorMarker --> [string] name of a column with mean intensity data (colour)
# title       --> [string: ""] name of the plot
# axisLim     --> [int: 2] upper limit of the axes
# small       --> [boolean: T] if TRUE, a small version of the plot is created
# << Output >>    [string] the path to the second created folder with name 'name'
plot.scatter3 = function(celldata, cluster, clusterN, Xmarker, Ymarker,
                         colorMarker, main = "", dim = 2, layout = "small") {
  # Select celldata of the selected clusters
  celldata = celldata[celldata[,cluster] %in% clusterN,]
  
  # Convert the markers into symbols to be used by ggplot
  x = sym(paste0("MI_", Xmarker))
  y = sym(paste0("MI_", Ymarker))
  
  if(grepl("ROI", colorMarker, fixed = T)) {
    c = sym(colorMarker)
  } else {
    c = sym(paste0("MI_", colorMarker))
  }
  
  # Change the size of the legend based on the layout parameter
  if (layout == "small") {
    keySize = unit(.010, "npc")
    keyPos = c(0.71, 0.90)
    keyMar = margin(t = 0.005,r = 0.005,b = 0.005,l = 0.005, unit = "npc")
    keyTextSize = 3
  } else {
    keySize = unit(.02, "npc")
    keyPos = c(0.75, 0.92)
    keyMar = margin(t = 0.01, r = 0.01, b = 0.01, l = 0.01, "npc")
    keyTextSize = 4
  }
  
  ggplot(data = celldata, aes(x = !!x, y = !!y)) +
    geom_point(shape = I(20), size = 1.5, aes(x = !!x, y = !!y, color = !!c)) +
    scale_color_gradientn(colours = rainbow(5)) + labs(color = colorMarker) +
    scale_x_continuous(limits = c(0,dim), expand = c(0,0),
                       oob = scales::squish) +
    scale_y_continuous(limits = c(0,dim), expand = c(0,0),
                       oob = scales::squish) +
    ggtitle(main) + xlab(Xmarker) + ylab(Ymarker) + theme_classic() +
    
    theme(plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
          plot.margin = unit(c(0.02, 0, .03, 0), units = "npc"),
          axis.title = element_text(size = 8, face = "bold"),
          axis.text = element_text(size = 8, colour = "black"),
          legend.title = element_text(size = 8, face= "bold"),
          legend.key.size = keySize, legend.position.inside =  keyPos,
          legend.margin = keyMar, legend.text = element_text(size = keyTextSize),
          legend.background = element_rect(fill = "grey80"),
          legend.justification = "center", legend.direction = "horizontal",
          panel.background = element_rect(fill = "grey95"), aspect.ratio = 1)
}

```


# using plot.tSNE  :checking the mix for group and ROI
```{r plot tSNE function}

# set colour for tSNE plot 
mycolors = sample(colorRampPalette(brewer.pal(8, "Set1"))(36))
# Plot the generated t-SNE with the current data
plot.tSNE = function(celldata, tSNEaxes, clustering, lvls, title,
                     labelClusters = T, savetSNE = F) {
  if (labelClusters) {
    clusterCenters = get.cluster.centers(celldata, tSNEaxes, clustering)
  }
  
  tSNEx = sym(tSNEaxes[1])
  tSNEy = sym(tSNEaxes[2])
  clustering = sym(clustering)
  
  if (missing(lvls)) {
    lvls = clustering
  }
## sample tSNE   I have alread samping 10,000 for making tSNE .there is still define function?  
  p = ggplot(celldata[sample(nrow(celldata), 20000),]) +
    geom_point(size = 0.1,
               aes(x = !!tSNEx, y= !!tSNEy,
                   colour = factor(!!clustering,
                                   levels = sort(unique(!!lvls))))) +
    scale_color_manual(values = mycolors) +
  
 # Plot the cluster centers
    {if (labelClusters) {
      list(geom_point(data = clusterCenters, size = 6, aes(x=x, y=y),
                      colour = "black", pch = 21, fill = "white",
                      show.legend = F),
           geom_text(data = clusterCenters, stat = "identity", show.legend = F,
              mapping = aes(x = x, y = y, label = cl, size = 12),
              colour = "black", size = 3))}} +
    
    theme_classic() +
    theme(plot.title = element_text(size = 20, hjust = 0.5),
          legend.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.text = element_text(size = 10)) +
    guides(colour = guide_legend(override.aes = list(size=5))) +
    ggtitle(title) 
## savetSNE
  if (savetSNE) {
    date = str_sub(gsub("-", "", Sys.Date()), -6, -1)
    title_name = gsub(pattern = " ", replacement =  "_", x = title)
    filename = paste0(date, "_t-SNE_", title_name, ".jpeg")
    ggsave(plot = p, device = "jpeg", bg = "white",
       width = 2500, height = 1700, dpi = 300, units = "px",
       path = OUTPUT_PATH, filename = filename)
  }
  
  return(p)
}
```

## Plot other tSNE
```{r}
### According to the requirement , decide save TSNE as F or T 
plot.tSNE(celldata_subsample, c("tSNE1", "tSNE2"), "ExpGroup",
          title = "Experimental model", labelClusters = F, savetSNE = T)
plot.tSNE(celldata_subsample, c("tSNE1", "tSNE2"), "ROI_ID", savetSNE = T,
          title = "ROI ID", labelClusters = F)


plottingtSNE = function(model) {
  levels = grep(pattern = model, x = unique(celldata_subsample$ROI_ID), value = T)
  p = plot.tSNE(celldata_subsample, c("tSNE1", "tSNE2"), "ROI_ID", lvls = levels,
          title = paste0(model, "_ROIs"), labelClusters = F, savetSNE = T)
  return(list(p))
}

exp_models = c("WT","CCR2KO")

sapply(X = exp_models, FUN = plottingtSNE)
```

# Heatmap
Generate a heatmap with markers versus clusters.
```{r}
#explanition of plotheatmap
# Plot heatmap -----------------------------------------------------------------
# Description : Create a heatmap matrix that contains mean expression data per
#               marker per level of the given factor. Rows in this matrix are
#               markers in 'markerlist', columns are levels in 'factor'. If 
# ---Parameters---
# celldata    --> [dataframe] a dataframe with marker intensity data.
# markerlist  --> [vector] a vector with names of columns of celldata with
#                 marker expression data that should be included in the heatmap.
# factor      --> [string] the name of a column of celldata that acts as a factor.
# title       --> [string] the title of the plot
# transpose   --> [boolean F] if T, columns and rows are interchanged
# scale       --> [string "column"] indicates whether the heatmap should be
#                 scaled by row or by column
# Rowv        --> [boolean F] if T, rows are reordered according to a dendrogram
# Colv        --> [boolean F] if T, columns are reordered acc. to a dendrogram
# margins     --> [vector c(4, 5)] a vector lenght 2, representing the size of  the bottom and right margin respectively
# srtCol      --> [int 0] indicates the angle at which the column labels are displayed
# barplot     --> [vector c()] a vector that contains column names of celldata
#                 that act as a factor. For each 'barplot factor', a plot with
#                 stacked barplots for each level of 'factor' is created showing
#                 the distribution of cells within that level over the levels
#                 of the 'barplot factor'. The levels of factor are plotted
#                 over de x axis in the same order as the heatmap.
# saveHM      --> [boolean F] if T the heatmap is automatically saved
# saveBP      --> [boolean F] if T the barplot(s) is/are automatically saved
# << Output >>    [image] A heatmap showing the mean marker expression for each
#                 marker in markerlist for all the levels in factor.
```


## Making heatmap for anncluster
```{r} 
# In this step, the order is also important 
lin_markers = c("CD45", "CD3e", "CD4", "Foxp3", "CD8a","B220",  "CD11c", "MHCII","CD103", 
"F480","CD68", "CD11b", "LY6G","Ly6C","EpCAM","CK19","aSMA","PECAM","CD44")
#checking the name


excl_cols = c("MI_TumourminusInterface", "MI_NormalminusInterface","MI_StructuralImage",
 "MI_InterfaceImage", "MI_Xenon131", "MI_Xenon132", "MI_DNA1",
  "MI_DNA2", "MI_Argon80")
mismatch_names <- setdiff(excl_cols, colnames(celldata))
print(mismatch_names) 
all_markers = grep("MI_", names(celldata), value = T)
all_markers = all_markers[!all_markers %in% excl_cols] %>%
  str_remove(pattern = "MI_")

lin_markers_check<- lin_markers[!lin_markers %in% all_markers]
lin_markers_check
# check the mismateched colnames and if character(0)then go on
#mismatch_names <- setdiff(lin_markers, colnames(celldata))
#print(mismatch_names)

# in this step ,  choose right K value, by testing different kinv and lin_marker to get best annotation .
unique(celldata$k15)#37 cluster
unique(celldata$k20)#32 cluster
unique(celldata$k25)#31 cluster
unique(celldata$k30)#30 cluster

# set the marker order of markerlist 


plot.heatmap2(celldata, lin_markers, "k15", title = "Cluster k15", Colv = T, srtCol = 90,scale = "column")
plot.heatmap2(celldata, lin_markers, "k20", title = "Cluster k20", Colv = T, srtCol = 90,scale = "column")
# will not choose K20 becasue CD3  single positvie cluster
plot.heatmap2(celldata, lin_markers, "k25", title = "Cluster k25", Colv = T, srtCol = 90,scale = "column")
plot.heatmap2(celldata, lin_markers, "k30", title = "Cluster k30", Colv = T, srtCol = 90,scale = "column")

# annoation based on k25
## IF colv =F ,then cluster name followed as cluster1-31, if Row=F . then rownames followed the lin_marker order.
plot.heatmap2(celldata, lin_markers, "k25", title = "Cluster k25", Colv = F,Rowv = F, srtCol = 90,scale = "row")
plot.heatmap2(celldata, all_markers, "k25", title = "Cluster k25", Colv = F,Rowv = F, srtCol = 90,scale = "column")

#save as both pdf and tiff/jpg
pdf(file = paste0(OUTPUT_PATH,"/Heatmap/lin_makers_expression_k25.pdf"),width = 10,height = 6)
plot.heatmap2(celldata, lin_markers, "k25",
              title = "lin_marker_expression",
              margins = c(10, 9), srtCol = 55, transpose = F,Colv = F,Rowv = F,scale = "column")
dev.off()


### After annotation 
pdf(file = paste0(OUTPUT_PATH,"/Heatmap/lin_makers_expression_anncluster.pdf"),width = 10,height = 6)
plot.heatmap2(celldata, lin_markers, "anncluster",
              title = "lin_marker_expression_anncluster",
              margins = c(10, 9), srtCol = 55, transpose = F,Colv = F,Rowv = F,scale = "column")
dev.off()

pdf(file = paste0(OUTPUT_PATH,"/Heatmap/all_makers_expression_anncluster.pdf"),width = 10,height = 6)
plot.heatmap2(celldata, all_markers, "anncluster",
              title = "lin_marker_expression_anncluster",
              margins = c(10, 9), srtCol = 55, transpose = F,Colv = F,Rowv = F,scale = "column")
dev.off()

pdf(file = paste0(OUTPUT_PATH,"/Heatmap/lin_makers_expression_annotation.pdf"),width = 10,height = 6)
plot.heatmap2(celldata, lin_markers, "annotation",
              title = "lin_marker_expression_annotation",
              margins = c(10, 9), srtCol = 55, transpose = F,Colv = F,Rowv = F,scale = "column")
dev.off()




# plot.heatmap2(celldata, lin_markers, "k25", title = "Cluster k25",margins=c(1,0.5), Colv = T, srtCol = 90,barplot = c("ExpGroup","ROI_ID"))
# plot.heatmap2(celldata, all_markers, "kinv25", title = "Cluster k40",margins=c(10,9),
#               Colv = T, srtCol = 90)
# plot.heatmap2(celldata, lin_markers, "kinv25", title = "Cluster k40",
#               Colv = T, srtCol = 90)
# # IF THE IMAGE DOESNT FIT THE  SIZE, MAYBE SET THE MARIN . 
# plot.heatmap2(celldata, lin_markers, "kinv25", title = "Cluster k40",key.par = list(mar = c(4,0.3,3,0.5)),
#               Colv = T, srtCol = 90)        


# plot.bp = function(clustern) {
#   filename = file.path(file.path(output_path, "Figures/ClusterSpread"),
#                        paste0(date, "_cluster", clustern, ".jpeg"))
#   jpeg(filename = filename, width = 700, height = 600, units = "px")
#   par(mar=c(8,3,0.8,0.8))
#    # par(mar=c(11,4,1,1))
#   barplot(table(celldata[celldata$kinv40 == clustern, "filename"]),
#                         las = 2, cex.names = 0.8)
#   dev.off()
# }
#sapply(c(1:34), plot.bp)
#scale ="rows can also be helpful to annotate "
plot.heatmap2(celldata, lin_markers, "kinv25", title = "Cluster k40",
              Colv = T, srtCol = 90, barplot = c("ExpGroup", "ROI_ID"), scale = "row")
plot.heatmap2(celldata, lin_markers, "kinv25", title = "Cluster k40",
              Colv = T, srtCol = 90, barplot = c("ExpGroup", "ROI_ID"), scale = "column")
```

R manual annotation  K25
```{r manual annotation}
# # Manually assign cluster labels ,current K25
celldata$anncluster = stringr::str_pad(celldata$k25, 2, side="left", pad="0") 
unique(celldata$anncluster)
table(celldata$anncluster)
# Split clusters based on thresholds for marker intensities
celldata[which(celldata$anncluster == "28"
               & celldata$MI_Foxp3 >= 0.5), "anncluster"] = "28A"
celldata[which(celldata$anncluster == "28"), "anncluster"] = "28B"
table(celldata$anncluster)



#250113 varified by xiaofei 
#Failed to capture the DC cluster. 
celldata[which(celldata$anncluster == "01"), "anncluster"] = "01_Tumour"
celldata[which(celldata$anncluster == "02"), "anncluster"] = "02_Tumour" # match to raw images and not neutrophils ,mainly spill over 
celldata[which(celldata$anncluster == "03"), "anncluster"] = "03_Neutrophils"
celldata[which(celldata$anncluster == "04"), "anncluster"] = "04_Fibroblasts"
celldata[which(celldata$anncluster == "05"), "anncluster"] = "05_Tumour"#
celldata[which(celldata$anncluster == "06"), "anncluster"] = "06_Macrophages"
# very hard to split  because CD11c MHCII CD68 and F480 coexpression or single pression . possible DC is in this cluster
celldata[which(celldata$anncluster == "07"), "anncluster"] = "07_Macrophages"
celldata[which(celldata$anncluster == "08"), "anncluster"] = "08_Tumour"
celldata[which(celldata$anncluster == "09"), "anncluster"] = "09_Tumour"#no marker 
celldata[which(celldata$anncluster == "10"), "anncluster"] = "10_Tumour"
celldata[which(celldata$anncluster == "11"), "anncluster"] = "11_Tumour"# 
celldata[which(celldata$anncluster == "12"), "anncluster"] = "12_Dendritic cells CD103"
celldata[which(celldata$anncluster == "13"), "anncluster"] = "13_Monocytes"#Ly6C and CD11b double positive 
celldata[which(celldata$anncluster == "14"), "anncluster"] = "14_Tumour"
celldata[which(celldata$anncluster == "15"), "anncluster"] = "15_Endothelium"
celldata[which(celldata$anncluster == "16"), "anncluster"] = "16_Tumour"#    small popolation ,seems tumour, few ly6C+
celldata[which(celldata$anncluster == "17"), "anncluster"] = "17_Macrophages"
#need to check other images, mainly CD11b and F480  ,a liitle bit CD11c  CD11b spill over ,a lots F480 CD68 
celldata[which(celldata$anncluster == "18"), "anncluster"] = "18_Endothelium"
celldata[which(celldata$anncluster == "19"), "anncluster"] = "19_Macrophages"
celldata[which(celldata$anncluster == "20"), "anncluster"] = "20_Macrophages"
celldata[which(celldata$anncluster == "21"), "anncluster"] = "21_Tumour"# B220 noise,F480 also noise 
celldata[which(celldata$anncluster == "22"), "anncluster"] = "22_Macrophages"
celldata[which(celldata$anncluster == "23"), "anncluster"] = "23_Epithelium"
celldata[which(celldata$anncluster == "24"), "anncluster"] = "24_B cells"
celldata[which(celldata$anncluster == "25"), "anncluster"] = "25_Tumour"
celldata[which(celldata$anncluster == "26"), "anncluster"] = "26_Epithelium"
celldata[which(celldata$anncluster == "27"), "anncluster"] = "27_T cell CD8"
celldata[which(celldata$anncluster == "28A"), "anncluster"] = "28A_Tregs"
celldata[which(celldata$anncluster == "28B"), "anncluster"] = "28B_T cell CD4"
celldata[which(celldata$anncluster == "29"), "anncluster"] = "29_Macrophages"
celldata[which(celldata$anncluster == "30"), "anncluster"] = "30_Fibroblasts"
celldata[which(celldata$anncluster == "31"), "anncluster"] = "31_Endothelium"
#identify by images 


celldata$annotation = str_split(celldata$anncluster,
                                      pattern = "_", simplify = TRUE)[,2]
unique(celldata$annotation)
annlevels = c("Tumour", "Fibroblasts", "Endothelium", "Epithelium",
           "T cell CD8", "T cell CD4", "Tregs", 
           "Dendritic cells CD103", "Macrophages","Monocytes", "Neutrophils", "B cells")
celldata$annotation = factor(celldata$annotation, levels = annlevels)
table(celldata$anncluster)
table(celldata$annotation)
celldata_count_perROI= celldata %>%
     group_by(anncluster,ROI_ID) %>%
     dplyr::summarise(totaln=n())
 View(celldata_count_perROI)

# Order the levels of the annotation column
plot.heatmap2(celldata, all_markers, "anncluster", title = "Annotated clusters",  margins = c(10, 5), srtCol = 60, Colv = T)
plot.heatmap2(celldata, lin_markers, "cell_type", title = "Annotated clusters",  margins = c(10, 5), srtCol = 60, Colv = T)
plot.heatmap2(celldata, lin_markers, "anncluster", title = "Annotated clusters",  margins = c(10, 5), srtCol = 60, Colv = T)
plot.heatmap2(celldata, lin_markers, "anncluster", title = "Annotated clusters",  margins = c(10, 5), srtCol = 60, Colv = T,scale = "row")
```
#checking annotation with scatter plot
```{r}
plot.scatter(celldata, "k25", 2, Xmarker = "LY6G", Ymarker = "CD44",dim=0.9)
plot.scatter(celldata, "k25", 2, Xmarker = "CD11b", Ymarker = "CD44",dim=0.9)
plot.scatter(celldata, "k25", 2, Xmarker = "CD11b", Ymarker = "LY6G",dim=0.5)
plot.scatter(celldata, "k25", 6, Xmarker = "CD44", Ymarker = "F480",dim=1)
plot.scatter(celldata, "k25", 6, Xmarker = "CD44", Ymarker = "CD68",dim=1)
plot.scatter(celldata, "k25", 6, Xmarker = "CD68", Ymarker = "MHCII",dim=1)
plot.scatter(celldata, "k25", 6, Xmarker = "CD68", Ymarker = "CD11c",dim=1)
plot.scatter(celldata, "k25", 6, Xmarker = "F480", Ymarker = "CD11c",dim=1)
plot.scatter(celldata, "k25", 6, Xmarker = "CD68", Ymarker = "MHCII",dim=1)
plot.scatter(celldata, "k25", 6, Xmarker = "CD11c", Ymarker = "MHCII",dim=1)
plot.scatter(celldata, "k25", 17, Xmarker = "CD11c", Ymarker = "CD68",dim=2)
plot.scatter(celldata, "k25", 17, Xmarker = "TIM3", Ymarker = "CD44",dim=2)
plot.scatter(celldata, "k25", 17, Xmarker = "CD44", Ymarker = "CK19",dim=2)
plot.scatter(celldata, "k25", 17, Xmarker = "F480", Ymarker = "MHCII",dim=4)
plot.scatter(celldata, "kinv25", 23, Xmarker = "CD11c", Ymarker = "MHCcII",dim=1)
#plot.scatter3(celldata, "kinv25", 26, "CD4", "Foxp3", "ExpGroup")
ggplot(celldata, aes(x = MI_MHCcII, y = MI_CD11c)) +
  xlim(0,2)+
  ylim(0,2)+
   geom_point(color = "blue", alpha = 0.7) +
  theme_minimal() 


```


#plot manual annotation results. 
```{r manual annotation}
# plot.heatmap2(celldata, lin_markers, "anncluster", title = "Annotated clusters",   margins = c(10, 5), srtCol = 60, Colv = T,key.par = list(mar = c(4,0.3,3,0.5)))
# plot.heatmap2(celldata, lin_markers, "annotation",
#               title = "Cell type expression pattern",
#               margins = c(10, 9), srtCol = 55, transpose = T,scale = "row",key.par = list(mar = c(4,0.3,3,0.5)))
plot.heatmap2(celldata, lin_markers, "anncluster", title = "Annotated clusters", scale = "row",  margins = c(10, 5), srtCol = 60, Colv = T)
plot.heatmap2(celldata, lin_markers, "anncluster", title = "Annotated clusters",  margins = c(10, 5), srtCol = 60, Colv = T)
#making pdf
pdf(file = paste0(OUTPUT_PATH,"/Heatmap/all_makers_expression_anncluster.pdf"),width = 8,height = 8)
plot.heatmap2(celldata, all_markers, "anncluster",
              title = "all_marker_expression",
              margins = c(10, 9), srtCol = 55, transpose = F,Colv = T,Rowv = T,scale = "column")
dev.off()
pdf(file = paste0(OUTPUT_PATH,"/Heatmap/cell_type_expression_allmarker.pdf"),width = 8,height = 6)
plot.heatmap2(celldata, all_markers, "annotation",
              title = "Cell type expression pattern",
              margins = c(10, 9), srtCol = 55, transpose =T,scale = "row")
dev.off()

pdf(file = paste0(OUTPUT_PATH,"/Heatmap/lin_markers_expression.pdf"),width = 8,height = 6)
plot.heatmap2(celldata, lin_markers, "anncluster", title = "Annotated clusters",   margins = c(10, 5), srtCol = 60, Colv = T)
dev.off
pdf(file = paste0(OUTPUT_PATH,"/Heatmap/lin_markers_expression.pdf"),width = 8,height = 6)
plot.heatmap2(celldata, lin_markers, "cell_type", title = "Marker Expression",   margins = c(10, 5), srtCol = 60, Colv = T)
dev.off
```

```{r}
## add  a new column cell_type for making heatmap or plot 
celldata$cell_type<-celldata$annotation
celldata$cell_type[celldata$cell_type=="Macrophages F480"]<-"Macrophages"
celldata$cell_type[celldata$cell_type=="Macrophages CD68"]<-"Macrophages"
celldata$cell_type[celldata$cell_type=="Fibroblasts aSMA"]<-"Fibroblasts"
celldata$cell_type[celldata$cell_type=="Fibroblasts Thy1.2"]<-"Fibroblasts"
celldata$cell_type[celldata$cell_type=="Fibroblasts"]<-"Fibroblasts"
celldata$cell_type[celldata$cell_type=="Dendritic cells CD103"]<-"Dendritic cells"
celldata$cell_type[celldata$cell_type=="Dendritic cells"]<-"Dendritic cells"
celldata$cell_type[celldata$cell_type=="T cells CD4"]<-"CD4 T cells"
celldata$cell_type[celldata$cell_type=="T cells CD8"]<-"CD8 T cells"
celldata$cell_type[celldata$cell_type=="Tregs"]<-"Treg cells"
celldata$cell_type[celldata$cell_type=="TCRgdt"]<-"TCRgdt cells"
celldata$cell_type[celldata$cell_type=="Uncertain"]<-"Uncertain"
unique(celldata$cell_type)
```



# checking and revise annotation --- umap checking  and ggplot checking 
## Umap 
### based on primary annotation , checking marker expression location 
###define UMAP 
```{r}
# Generate new UMAP ------------------------------------------------------------
# Description : Generate a new UMAP with the selected clusters and markers
# ---Parameters---
# celldata  --> [dataframe] a dataframe with mean intensity data by marker
# clusters  --> [vector] a vector with levels of the factor 'anncluster' that should be included
# markers   --> [vector] a vector with column names of celldata with marker
#               expression data that should be used to generate the UMAP
# nsample   --> [numeric] the number of cells that should be subsampled from celldata
# << Output >>  [dataframe] the selected subset of celldata with UMAP coordinates
generate.UMAP = function(celldata, clusters, markers, nsample, filename) {
  data = celldata[celldata$anncluster %in% clusters,]
  data = data[sample(x = nrow(data), size = nsample),]
  umapResults = umap(data[,markers], verbose = T, n_neighbors = 10)
  data$umap1 = umapResults$layout[,1]
  data$umap2 = umapResults$layout[,2]
  write.csv(x = data, file = file.path(OUTPUT_PATH, filename), row.names = T)
  return(data)
}

# Plot UMAP -------------------------------------------------------------------
# Description : Plot cells on a plane according to their UMAP coordinates,
#               coloured according to levels of factor 
# ---Parameters---
# UMAPdf    --> [dataframe] a dataframe with UMAP data.
# factor    --> [string] name of a column of 'UMAPdf' that acts as a factor
# celltype  --> [string] a string that represents the type of cells in the UMAP
# lgndttl   --> [string] the title of plot legend
# << Output >>  [image] the generated UMAP
plot.UMAP = function(UMAPdf, factor, celltype, lgndttl) {
  factor = sym(factor)
  
  p = ggplot(UMAPdf, aes(x=umap1, y=umap2, colour = !!factor)) + 
    geom_point(size = 0.3) +
    guides(colour = guide_legend(override.aes = list(size=5), title = lgndttl)) +
    scale_color_manual(values = cluster_cols) + ggtitle(celltype) + 
    theme_classic() + labs(x = "UMAP 1", y = "UMAP 2") +
    theme(plot.background = element_blank(),
          axis.title = element_text(size = 15),
          legend.text = element_text(size = 15),
          legend.title = element_text(size = 17, face = "bold"),
          plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
          panel.grid = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank())
  
  celltype = str_replace_all(celltype, " ", "_")
  lgndttl = str_replace_all(lgndttl, " ", "_")
  filename = paste0("UMAP_", celltype, "_", lgndttl, ".jpeg")
  
  directory = create.resultsdir(path = OUTPUT_PATH,
                                name = paste0(celltype, "_UMAP"))
  
  ggsave(filename = filename, path = directory,
         bg = "white", width = 2100, height = 1700, units = "px")
  
  print(p)
}

# Plot UMAP -------------------------------------------------------------------
# Description : Plot cells on a plane according to their UMAP coordinates,
#               coloured according to their expression of 'marker'  
# ---Parameters---
# UMAPdf    --> [dataframe] a dataframe with UMAP data.
# marker    --> [string] name of a column of 'UMAPdf' with expression data of a marker
# celltype  --> [string] a string that represents the type of cells in the UMAP
# << Output >>  [image] the generated UMAP
plot.UMAPmarker = function(UMAPdf, marker, celltype) {
  colour = sym(marker)
  title = paste(celltype, str_remove(marker, "MI_"), "expression")
  p = ggplot(UMAPdf, aes(x=umap1, y=umap2, colour = !!colour)) + 
    geom_point(size = 0.3) + ggtitle(title) + 
    theme_classic() + labs(x = "UMAP 1", y = "UMAP 2") +
    theme(plot.background = element_blank(),
          axis.title = element_text(size = 15),
          legend.text = element_text(size = 15),
          legend.title = element_blank(),
          plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
          panel.grid = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank()) +
    scale_color_distiller(palette = "Spectral", limits = c(0,3))
  
  celltype = str_replace_all(celltype, " ", "_")
  filename = paste0("UMAP_", celltype, "_", str_remove(marker, "MI_"), ".jpeg")
  
  directory = create.resultsdir(path = OUTPUT_PATH,
                                name = paste0(celltype, "_UMAP"))
  
  ggsave(filename = filename, path = directory,
         bg = "white", width = 2100, height = 1700, units = "px")
  
  print(p)
}

cluster_cols = c( "#FFF4A4FF",  "#ABDDA4FF", "#618F75FF",  "#336666",
               "#4E79A7FF", "#A0CBE8FF","#938ABBFF",  "#B07AA1FF",
               "#FF9D9AFF", "#CC6666",  "#704850FF",  "#8C8C8C", "#FFD700",   "#00FF7F",   "#8B4513",  "#FF6347",  "#40E0D0",   "#7FFF00",  
  "#DC143C", "#8B0000","#F0E442", "#0072B2", "#D55E00", "#CC79A7", 'red','pink','purple','blue',"#8FBC8B", "#6A5ACD", "#4682B4", "#FF4500", "#2E8B57",
"#483D8B", "#FF1493", "#FF8C00", "#98FB98", "#556B2F",
"#CD5C5C", "#00008B", "#FFDAB9", "#BA55D3", "#87CEEB",
"#B0E0E6", "#5F9EA0")


```

##generate umap 
```{r new UMAPs}
## Umap markers here is important , there are two ways : one is lineage marker to get less noise, another one is useing all the markers that expressed on clusters ,depend on use for checking the annotation or ..
get.clusters = function(patterns) {
  clusters = sapply(X = patterns, FUN = grep, x = unique(celldata$anncluster), value = T)
  clusters = unlist(clusters, use.names = F)
  return(clusters)
} 

if (F) {
  # T cells
  TCellClusters = get.clusters(patterns = c("T cell","TCR","Tregs"))
  TCellMarkers = c("MI_CD3", "MI_CD45", "MI_CD4", "MI_CD8", "MI_Foxp3",
 "MI_LAG3", "MI_PD1", "MI_TCRgd", "MI_TIM3")
  print(TCellClusters)
# TColumns = c("CD103", "CD3e", "CD45", "CD4",  "Foxp3", "Ki67", "LAG3","CD8a",
#  "PD1", "Casp3")
# TColumns = paste0("MI_", TColumns)
#   TCclusters = c("09B_T cells CD4", "09A_Tregs","28_T cells CD8")
# print(TCclusters)
set.seed(222)
  TCD = generate.UMAP(celldata = celldata, clusters = TCellClusters,
                      markers = TCellMarkers, nsample = 5000, filename = "241101TCD.csv")
set.seed(111)  
  # Macrophages & Dendritic cells
  MacDendCellClusters = get.clusters(patterns = c("Macrophage", "Dendritic","DC"))
  MacDendCellColumns = c("MI_MHCcII", "MI_F480", "MI_CD103", "MI_PDL1", "MI_CD86",
                         "MI_CD68", "MI_CD206",  "MI_CD11c", "MI_CD11b", "MI_CD44") #, "MI_LY6G",  "MI_CD44")
  MacDendCD = generate.UMAP(celldata = celldata, clusters = MacDendCellClusters,
                            markers = MacDendCellColumns, nsample = 20000,
                            filename = "241212MacDendCD.csv")
  
   set.seed(222)  
  # Macrophages & Dendritic cells
  MacDendTumCellClusters = get.clusters(patterns = c("Macrophage", "Dendritic","DC","Tumour"))
  MacDendTumCellColumns = c("MI_MHCcII", "MI_F480", "MI_CD103", "MI_PDL1", "MI_CD86","MI_CD24",
                         "MI_CD68", "MI_CD206",  "MI_CD11c", "MI_CD11b","MI_LY6G","MI_EPCAM", "MI_PancK","MI_PVR","MI_CD44","MI_PDL1") #, "MI_LY6G",  "MI_CD44")
  MacDendTumCD = generate.UMAP(celldata = celldata, clusters = MacDendTumCellClusters,
                            markers = MacDendTumCellColumns, nsample = 20000,
                            filename = "241212MacDendTumCD.csv")
  
    
set.seed(222)  
  # Macrophages & Dendritic cells
  MacDendMonoTumCellClusters = get.clusters(patterns = c("Macrophage", "Dendritic","DC","Monocytes","Tumour"))
  MacDendMonoTumCellColumns = c("MI_MHCII", "MI_F480", "MI_CD103", "MI_PDL1", "MI_CD86",
                         "MI_CD68", "MI_CD206",  "MI_CD11c", "MI_CD11b","MI_LY6G","MI_EpCAM","MI_Ly6C", "MI_CK19","MI_PVR","MI_CD44","MI_PDL1") #, "MI_LY6G",  "MI_CD44")
    MacDendMonoTumCellClusters = get.clusters(patterns = c("Macrophage", "Dendritic","DC","Monocytes","Tumour"))
  MacDendMonoTumCellColumns_lineage = c("MI_MHCII", "MI_F480", "MI_CD103", 
                         "MI_CD68",  "MI_CD11c", "MI_CD11b","MI_LY6G","MI_EpCAM","MI_Ly6C", "MI_CK19","MI_CD44") #, "MI_LY6G",  "MI_CD44")
  MacDendMonoTumCD = generate.UMAP(celldata = celldata, clusters = MacDendMonoTumCellClusters,
                            markers = MacDendMonoTumCellColumns_lineage, nsample = 20000,
                            filename = "250115MacDendMonoTumCD.csv")
  
  set.seed(222)  
  # Macrophages & Dendritic cells
  MacDendNeuCellClusters = get.clusters(patterns = c("Macrophage", "Dendritic","DC","Neutrophils"))
  MacDendNeuCellColumns = c("MI_MHCcII", "MI_F480", "MI_CD103", "MI_PDL1", "MI_CD86",
                         "MI_CD68", "MI_CD206",  "MI_CD11c", "MI_CD11b","MI_LY6G",  "MI_CD44") #, "MI_LY6G",  "MI_CD44")
  MacDendNeuCD = generate.UMAP(celldata = celldata, clusters = MacDendNeuCellClusters,
                            markers = MacDendNeuCellColumns, nsample = 20000,
                            filename = "241213MacDendNeuCD.csv")
  
    set.seed(111)  
  # Macrophages & Dendritic cells & Monocytes 
  MacDendMonoCellClusters = get.clusters(patterns = c("Macrophage", "Dendritic","DC","Monocytes"))
  MacDendMonoCellColumns = c("MI_MHCII", "MI_F480", "MI_CD103", "MI_PDL1", "MI_CD86",
                         "MI_CD68", "MI_CD206",  "MI_CD11c", "MI_CD11b","MI_LY6G",  "MI_CD44","MI_Ly6C") #, "MI_LY6G",  "MI_CD44")
   MacDendMonoCellColumns_lineage= c("MI_MHCII", "MI_F480", "MI_CD103", 
                        "MI_CD68",  "MI_CD11c", "MI_CD11b", "MI_Ly6C")
  MacDendMonoCD = generate.UMAP(celldata = celldata, clusters = MacDendMonoCellClusters,
                            markers = MacDendMonoCellColumns, nsample = 20000,
                            filename = "250115_allmarkers_MacDendMonoCD.csv")
  MacDendMonoCD = generate.UMAP(celldata = celldata, clusters = MacDendMonoCellClusters,
                            markers = MacDendMonoCellColumns_lineage, nsample = 20000,
                            filename = "250115_linmarkers_MacDendMonoCD.csv")
  
  
 set.seed(222) 
  # Tumour cells
  TUMClusters = get.clusters(patterns = c("Tumour"))
  TUMColumns =  c("MI_EPCAM", "MI_PancK","MI_PVR","MI_casp3","MI_CD44","MI_PDL1","MI_Ki67","MI_pS6","MI_CD24")#, "MI_PDL1",  "MI_CD44")
  TUMCD = generate.UMAP(celldata = celldata, clusters = TUMClusters,
                        markers = TUMColumns, nsample = 20000,
                        filename = "241101TUMCD.csv")
  #TumourFibNeu cells
 set.seed(222)
   TumourFibNeuClusters = get.clusters(patterns = c("Tumour","Fibroblasts","Neut"))
  TumourFibNeuColumns =  c("MI_EPCAM", "MI_PancK","MI_PVR","MI_casp3","MI_CD44","MI_PDL1","MI_Ki67","MI_pS6","MI_CD11b","MI_LY6G","MI_aSMA","MI_Vimentin","MI_CollagenI")#, "MI_PDL1",  "MI_CD44")
  TumourFibNeuCD = generate.UMAP(celldata = celldata, clusters = TumourFibNeuClusters,
                        markers = TumourFibNeuColumns, nsample = 20000,
                        filename = "241101TumourFibNeuCD.csv")
  

set.seed(222)
CellClusters= unique(celldata$anncluster)
CellClusters
# code for all_markers
all_markers = all_markers[!all_markers %in% excl_cols]
CellColumns <- paste0("all_markers = c(", paste0('"', all_markers, '"', collapse = ","), ")")
# Print the formatted string
cat(CellColumns)
CellColumns = c("MI_B220","MI_CD103","MI_CD11b","MI_CD11c","MI_CD206","MI_CD3e","MI_CD44","MI_CD45","MI_CD4","MI_CD68","MI_CD86","MI_CD8a","MI_CK19","MI_CXCL9","MI_Casp3","MI_EpCAM","MI_F480","MI_Foxp3","MI_Ki67","MI_LAG3","MI_LY6G","MI_Ly6C","MI_MGL2","MI_MHCII","MI_NK1_1","MI_PD1","MI_PDL1","MI_PDPN","MI_PECAM","MI_PVR","MI_Sirpa","MI_TCRgdt","MI_TIM3","MI_Thy1_2","MI_Vimentin","MI_aSMA","MI_pS6")

CellCD= generate.UMAP(celldata = celldata, clusters = CellClusters,
                            markers = CellColumns, nsample = 20000,
                            filename = "250113CellCD.csv")

  }

```

###plot umap function 

```{r}
# Define the function to plot UMAP
plot_umap <- function(data, color_var, plot_title, legend_title, file_name, subfolder) {

# Create the ggplot
p <- ggplot(data, aes(x=umap1, y=umap2, colour = as.factor(data[[color_var]]))) + 
  geom_point(size = 0.3) + 
  ggtitle(plot_title) + 
  guides(colour = guide_legend(override.aes = list(size = 5), title = legend_title)) +
  theme_classic() + 
  labs(x = "UMAP 1", y = "UMAP 2") +
  theme(plot.background = element_blank(),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 10, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        panel.grid = element_blank(),
        axis.ticks = element_blank()) +
  scale_color_manual(values = cluster_cols)
# Save the plot
ggsave(filename = file_name,
       path = file.path(OUTPUT_PATH,subfolder),
       bg = "white",
       width = 2100, height = 1700, units = "px")
return(p)
}
# T cell 
plot_umap(TCD,color_var = "anncluster",plot_title="U-MAP T cells",legend_title = "Clusters",file_name="UMAP_T_cell_cluster.jpeg",subfolder = "UMAP/T_Cell_markers")
plot_umap(TCD,color_var = "annotation",plot_title="U-MAP T cells",legend_title = "Annotation",file_name="UMAP_T_cell_annotation.jpeg",subfolder = "UMAP/T_Cell_markers")
plot_umap(TCD,color_var = "ExpGroup",plot_title="U-MAP T cells",legend_title = "Group",file_name="UMAP_T_cell_group.jpeg",subfolder = "UMAP/T_Cell_markers")
# Myloid cell
MacDendCD_filter<-MacDendCD
MacDendCD_filter= MacDendCD_filter[MacDendCD_filter$umap1<10,]
MacDendCD_filter= MacDendCD_filter[MacDendCD_filter$umap2<15,]
#ggplot(MacDendCD_filter,aes(x=umap1,y=umap2,colour="ExpGroup"))
plot_umap(MacDendCD_filter,color_var = "anncluster",plot_title="U-MAP MacDend cells",legend_title = "Clusters",file_name="UMAP_MacDendCD_cluster.jpeg",subfolder = "UMAP/MacDendCD_markers")
plot_umap(MacDendCD_filter,color_var = "annotation",plot_title="U-MAP MacDend cells",legend_title = "Annotation",file_name="UMAP_MacDendCD_annotation.jpeg",subfolder = "UMAP/MacDendCD_markers")
plot_umap(MacDendCD_filter,color_var = "ExpGroup",plot_title="U-MAP MacDend cells",legend_title = "Group",file_name="UMAP_MacDendCD_group.jpeg",subfolder = "UMAP/MacDendCD_markers")


MacDendMonoCD_filter<-MacDendMonoCD
MacDendMonoCD_filter= MacDendMonoCD_filter[MacDendMonoCD_filter$umap1>-15,]
MacDendMonoCD_filter= MacDendMonoCD_filter[MacDendMonoCD_filter$umap2>-10,]
#ggplot(MacDendCD_filter,aes(x=umap1,y=umap2,colour="ExpGroup"))
plot_umap(MacDendMonoCD_filter,color_var = "anncluster",plot_title="U-MAP MacDendMono cells",legend_title = "Clusters",file_name="UMAP_MacDendMonoCD_cluster.jpeg",subfolder = "UMAP/MacDendMonoCD_markers")
plot_umap(MacDendMonoCD_filter,color_var = "annotation",plot_title="U-MAP MacDendMono cells",legend_title = "Annotation",file_name="UMAP_MacDendMonoCD_annotation.jpeg",subfolder = "UMAP/MacDendMonoCD_markers")
plot_umap(MacDendMonoCD_filter,color_var = "ExpGroup",plot_title="U-MAP MacDendMono cells",legend_title = "Group",file_name="UMAP_MacDendMonoCD_group.jpeg",subfolder = "UMAP/MacDendMonoCD_markers")

MacDendMonoTumCD_filter<-MacDendMonoTumCD
MacDendMonoTumCD_filter= MacDendMonoTumCD_filter[MacDendMonoTumCD_filter$umap1<10,]
MacDendMonoTumCD_filter= MacDendMonoTumCD_filter[MacDendMonoTumCD_filter$umap2<15,]
#ggplot(MacDendCD_filter,aes(x=umap1,y=umap2,colour="ExpGroup"))
plot_umap(MacDendMonoTumCD_filter,color_var = "anncluster",plot_title="U-MAP MacDendMonoTum cells",legend_title = "Clusters",file_name="UMAP_MacDendMonoTumCD_cluster.jpeg",subfolder = "UMAP/MacDendMonoTumCD_markers")
plot_umap(MacDendMonoTumCD_filter,color_var = "annotation",plot_title="U-MAP MacDendMonoTum cells",legend_title = "Annotation",file_name="UMAP_MacDendMonoTumCD_annotation.jpeg",subfolder = "UMAP/MacDendMonoTumCD_markers")
plot_umap(MacDendMonoTumCD_filter,color_var = "ExpGroup",plot_title="U-MAP MacDendMonoTum cells",legend_title = "Group",file_name="UMAP_MacDendMonoTumCD_group.jpeg",subfolder = "UMAP/MacDendMonoTumCD_markers")



# Tumor cell
plot_umap(TUMCD,color_var = "anncluster",plot_title="U-MAP Tumour cells",legend_title = "Clusters",file_name="UMAP_TUMCD_cluster.jpeg",subfolder = "UMAP/TUMCD_markers")
plot_umap(TUMCD,color_var = "annotation",plot_title="U-MAP Tumour cells",legend_title = "Annotation",file_name="UMAP_TUMCD_annotation.jpeg",subfolder = "UMAP/TUMCD_markers")
plot_umap(TUMCD,color_var = "ExpGroup",plot_title="U-MAP Tumour cells",legend_title = "Group",file_name="UMAP_TUMCD_group.jpeg",subfolder = "UMAP/TUMCD_markers")
# 
# # myloid+fib+Tumor
# MacFibTumNeuCD_filter<-MacFibTumNeuCD
# MacFibTumNeuCD_filter= MacFibTumNeuCD_filter[MacFibTumNeuCD_filter$umap1>-10,]
# MacFibTumNeuCD_filter= MacFibTumNeuCD_filter[MacFibTumNeuCD_filter$umap2>-10,]
# plot_umap(MacFibTumNeuCD_filter,color_var = "anncluster",plot_title="U-MAP MacFibTumNeuCD cells",legend_title = "Clusters",file_name="UMAP_MacFibTumNeuCD_cluster.jpeg",subfolder = "UMAP/MacFibTumNeuCD_markers")
# plot_umap(MacFibTumNeuCD_filter,color_var = "annotation",plot_title="U-MAP MacFibTumNeuCD cells",legend_title = "Annotation",file_name="UMAP_MacFibTumNeuCD_annotation.jpeg",subfolder = "UMAP/MacFibTumNeuCD_markers")
# plot_umap(MacFibTumNeuCD_filter,color_var = "ExpGroup",plot_title="U-MAP MacFibTumNeuCD cells",legend_title = "Group",file_name="UMAP_MacFibTumNeuCD_group.jpeg",subfolder = "UMAP/MacFibTumNeuCD_markers")

#CellCD
CellCD_filter<-CellCD
CellCD_filter= CellCD_filter[CellCD_filter$umap1>-10,]
CellCD_filter= CellCD_filter[CellCD_filter$umap2>-10,]
plot_umap(CellCD_filter,color_var = "anncluster",plot_title="U-MAP all cells",legend_title = "Clusters",file_name="UMAP_CellCD_cluster.jpeg",subfolder = "UMAP/CellCD_markers")
plot_umap(CellCD_filter,color_var = "annotation",plot_title="U-MAP all cells",legend_title = "Annotation",file_name="UMAP_CellCD_annotation.jpeg",subfolder = "UMAP/CellCD_markers")
plot_umap(CellCD_filter,color_var = "ExpGroup",plot_title="U-MAP all cells",legend_title = "Group",file_name="UMAP_CellCD_group.jpeg",subfolder = "UMAP/CellCD_markers")
plot_umap(CellCD_filter,color_var = "cell_type",plot_title="U-MAP all cells",legend_title = "cell_type",file_name="UMAP_CellCD_cell_type.jpeg",subfolder = "UMAP/CellCD_markers")

# # myloid_fib+neu
# MacDendFibNeuCD_filter<-MacDendFibNeuCD
# MacDendFibNeuCD_filter= MacDendFibNeuCD_filter[MacDendFibNeuCD_filter$umap1<20,]
# MacDendFibNeuCD_filter= MacDendFibNeuCD_filter[MacDendFibNeuCD_filter$umap2<20,]
# MacDendFibNeuCD_filter= MacDendFibNeuCD_filter[MacDendFibNeuCD_filter$umap2>-10,]
# plot_umap(MacDendFibNeuCD_filter,color_var = "anncluster",plot_title="U-MAP MacDendFibNeuCD cells",legend_title = "Clusters",file_name="UMAP_MacDendFibNeuCD_cluster.jpeg",subfolder = "UMAP/MacDendFibNeuCD_markers")
# plot_umap(MacDendFibNeuCD_filter,color_var = "annotation",plot_title="U-MAP MacDendFibNeuCD cells",legend_title = "Annotation",file_name="UMAP_MacDendFibNeuCD_annotation.jpeg",subfolder = "UMAP/MacDendFibNeuCD_markers")
# plot_umap(MacDendFibNeuCD_filter,color_var = "ExpGroup",plot_title="U-MAP MacDendFibNeuCD cells",legend_title = "Group",file_name="UMAP_MacDendFibNeuCD_group.jpeg",subfolder = "UMAP/MacDendFibNeuCD_markers")


```


# xiaofei plot marker expression on Umap
```{r new UMAPs}
for (i in TCellMarkers){
  marker = str_remove(i, "MI_")
  p = ggplot(TCD,
             aes(x=umap1, y=umap2, colour = get(i))) + 
    geom_point(size = 0.3) + ggtitle(paste0("T cell ", marker, " expression")) + 
    theme_classic() + labs(x = "UMAP 1", y = "UMAP 2") +
    theme(plot.background = element_blank(),
          axis.title = element_text(size = 15),
          legend.text = element_text(size = 15),
          legend.title = element_blank(),
          plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
          panel.grid = element_blank(),
          #axis.text = element_blank(),
          axis.ticks = element_blank()) +
    scale_color_distiller(palette = "Spectral", limits = c(0,2))
  ggsave(filename = paste0("UMAP_T_cell_", marker, "_expression.jpeg"),
         path = file.path(OUTPUT_PATH, "UMAP/T_Cell_markers"), bg = "white",
         width = 2100, height = 1700, units = "px")
  print(p)
}
##MacDend markers
for (i in MacDendMonoCellColumns){
  marker = str_remove(i, "MI_")
  p = ggplot(MacDendMonoCD_filter,
             aes(x=umap1, y=umap2, colour = get(i))) + 
    geom_point(size = 0.3) + ggtitle(paste0("MacDend cell ", marker, " expression")) + 
    theme_classic() + labs(x = "UMAP 1", y = "UMAP 2") +
    theme(plot.background = element_blank(),
          axis.title = element_text(size = 15),
          legend.text = element_text(size = 15),
          legend.title = element_blank(),
          plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
          panel.grid = element_blank(),
          #axis.text = element_blank(),
          axis.ticks = element_blank()) +
    scale_color_distiller(palette = "Spectral", limits = c(0,2))
  ggsave(filename = paste0("UMAP_MacDendMono_cell_", marker, "_expression.jpeg"),
         path = file.path(OUTPUT_PATH, "UMAP/MacDendMonoCD_markers"), bg = "white",
         width = 2100, height = 1700, units = "px")
  print(p)
}
## tumor markers
for (i in TUMColumns){
  marker = str_remove(i, "MI_")
  p = ggplot(TUMCD,
             aes(x=umap1, y=umap2, colour = get(i))) + 
    geom_point(size = 0.3) + ggtitle(paste0("Tumour cell ", marker, " expression")) + 
    theme_classic() + labs(x = "UMAP 1", y = "UMAP 2") +
    theme(plot.background = element_blank(),
          axis.title = element_text(size = 15),
          legend.text = element_text(size = 15),
          legend.title = element_blank(),
          plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
          panel.grid = element_blank(),
          #axis.text = element_blank(),
          axis.ticks = element_blank()) +
    scale_color_distiller(palette = "Spectral", limits = c(0,2))
  ggsave(filename = paste0("UMAP_Tumour_cell_", marker, "_expression.jpeg"),
         path = file.path(OUTPUT_PATH, "UMAP/TUMCD_markers"), bg = "white",
         width = 2100, height = 1700, units = "px")
  print(p)
}
##plot MacDendFibTum marker  MacFibTumNeuCD
for (i in MacDendMonoTumCellColumns){
  marker = str_remove(i, "MI_")
  p = ggplot(MacDendMonoTumCD_filter,
             aes(x=umap1, y=umap2, colour = get(i))) + 
    geom_point(size = 0.3) + ggtitle(paste0("MacDendMonoTumCD cell ", marker, " expression")) + 
    theme_classic() + labs(x = "UMAP 1", y = "UMAP 2") +
    theme(plot.background = element_blank(),
          axis.title = element_text(size = 15),
          legend.text = element_text(size = 15),
          legend.title = element_blank(),
          plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
          panel.grid = element_blank(),
          #axis.text = element_blank(),
          axis.ticks = element_blank()) +
    scale_color_distiller(palette = "Spectral", limits = c(0,2))
  ggsave(filename = paste0("UMAP_MacDendMonoTumCD_cell_", marker, "_expression.jpeg"),
         path = file.path(OUTPUT_PATH, "UMAP/MacDendMonoTumCD_markers"), bg = "white",
         width = 2100, height = 1700, units = "px")
  print(p)
}
for (i in MacFibTumNeuColumns){
  marker = str_remove(i, "MI_")
  p = ggplot(MacFibTumNeuCD_filter,
             aes(x=umap1, y=umap2, colour = get(i))) + 
    geom_point(size = 0.3) + ggtitle(paste0("MacFibTumNeuCD cell ", marker, " expression")) + 
    theme_classic() + labs(x = "UMAP 1", y = "UMAP 2") +
    theme(plot.background = element_blank(),
          axis.title = element_text(size = 15),
          legend.text = element_text(size = 15),
          legend.title = element_blank(),
          plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
          panel.grid = element_blank(),
          #axis.text = element_blank(),
          axis.ticks = element_blank()) +
    scale_color_distiller(palette = "Spectral", limits = c(0,2))
  ggsave(filename = paste0("UMAP_MacFibTumNeuCD_cell_", marker, "_expression.jpeg"),
         path = file.path(OUTPUT_PATH, "UMAP/MacFibTumNeuCD_markers"), bg = "white",
         width = 2100, height = 1700, units = "px")
  print(p)
}
for (i in CellColumns){
  marker = str_remove(i, "MI_")
  p = ggplot(CellCD_filter,
             aes(x=umap1, y=umap2, colour = get(i))) + 
    geom_point(size = 0.3) + ggtitle(paste0("CellCD cell ", marker, " expression")) + 
    theme_classic() + labs(x = "UMAP 1", y = "UMAP 2") +
    theme(plot.background = element_blank(),
          axis.title = element_text(size = 15),
          legend.text = element_text(size = 15),
          legend.title = element_blank(),
          plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
          panel.grid = element_blank(),
          #axis.text = element_blank(),
          axis.ticks = element_blank()) +
    scale_color_distiller(palette = "Spectral", limits = c(0,2))
  ggsave(filename = paste0("UMAP_CellCD_cell_", marker, "_expression.jpeg"),
         path = file.path(OUTPUT_PATH, "UMAP/CellCD_markers"), bg = "white",
         width = 2100, height = 1700, units = "px")
  print(p)
}



```
```{r}
#umap checking threshold
TUMCD$color <- ifelse(TUMCD$MI_EPCAM > 0.1, "black", "other")
TUMCD$color <- ifelse(TUMCD$MI_PancK > 0.2, "black", "other")
ggplot(TUMCD,
       aes(x = umap1, y = umap2, colour = color)) +
  geom_point(size = 0.3) + 
  ggtitle("U-MAP TUMCD cells") + 
  guides(colour = guide_legend(override.aes = list(size = 5), title = "Cluster")) +
  theme_classic() + 
  labs(x = "UMAP 1", y = "UMAP 2") +
  theme(plot.background = element_blank(),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 17, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
        panel.grid = element_blank(),
        axis.ticks = element_blank()) +
  scale_color_manual(values = c("black" = "black", "other" = "grey"))

```






#ggplot checking
# plot dots on all original image or on specific image for checking the cutoff
##plot dots on all original image
```{r}
# CD206,CD80 CD86 CD44 CD24_Tumour MHCII Ki67 LAG3 MHCII PD1 PDL1   TIM3   Thy1.2  casp3 pS6  PVR 


#plot.scatter(celldata, "kinv25", 4, "CD11c", "MHCcII",dim=1)
#plot.scatter(celldata, cluster = "kinv40", clusterN = c(16), Xmarker = "EpCAM", Ymarker = "aSMA",dim=1)
ggplot(celldata, aes(x= Location_Center_X, y = -Location_Center_Y)) +
  geom_point(data=celldata,size = 0.01, color = "black") +
   #geom_point(data = celldata[which(celldata$annotation=="Tumour"),], size = 0.01, colour = "yellow") +
  #geom_point(data = celldata[which(celldata$anncluster=="01A_Macrophages F480"),], size = 0.01, colour = "yellow") +

#geom_point(data = celldata[which(celldata$anncluster=="17A"),], size = 0.01, colour = "red") +
geom_point(data = celldata[which(celldata$MI_CD11c>=0.5 &celldata$k25=="6"),], size = 0.01, colour = "yellow") +
  #geom_point(data = celldata[which(celldata$k25=="17"),], size = 0.01, colour = "yellow") +
 # geom_point(data = celldata[which(celldata$kinv25=="20"),], size = 0.01, colour = "blue") +
  
  # geom_point(data = celldata[which(celldata$annotation=="Macrophages"),], size = 0.01, colour = "red") +
  # geom_point(data = celldata[which(celldata$annotation=="Fibroblasts"),], size = 0.01, colour = "yellow") +
           #geom_point(data = celldata[which(celldata$kinv25=="30"&celldata$MI_CD11c>0.2),],
           #           | celldata$MI_EpCAM >=0.375)),],      
          
  #geom_point(data = celldata[which(celldata$kinv33 =="11"& celldata$MI_CD44>0.4),], size = 0.01, colour = "red")+

  #geom_point(data = celldata[which(celldata$anncluster =="02A_Tumour" & celldata$MI_CK19 >0.2),], size = 0.01, colour = "red")+

  theme_classic() +
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        panel.background=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        strip.text = element_text(size = 8),
        strip.background = element_rect(),
        panel.spacing = unit(0, "mm"),
        plot.background = element_blank())+
  facet_wrap(~ROI_ID,nrow=3)
```
##plot dots on one specific original image
```{r}
#lag3 0.5PVR 0.25 almost all 0.3 clealy less MHCII   0.25 PDL1  0.15 CD24  0.2 PS6 0.2  Casp 0.3 colleagen
ROI13<-subset(celldata, ROI_ID == "07_MOC2_WT") #  "01_MOC2_CCR2KO" "02_MOC2_CCR2KO" "03_MOC2_CCR2KO" "04_MOC2_CCR2KO" "05_MOC2_CCR2KO" "06_MOC2_CCR2KO" "07_MOC2_WT"     "08_MOC2_WT"     "09_MOC2_WT"    [10] "10_MOC2_WT"     "11_MOC2_WT" 
ggplot(ROI13, aes(x= Location_Center_X, y = -Location_Center_Y)) +
  #ggplot(celldata, aes(x= Location_Center_X, y = -Location_Center_Y)) +
  geom_point(size = 0.5, color = "black") +
    #geom_point(data = ROI13[which(ROI13$annotation=="B cells"),], size = 0.1, colour = "red")+
  #geom_point(data = ROI13[which(ROI13$annotation=="B cells"&ROI13$MI_CollagenI>0.5),], size = 0.1, colour = "yellow")+
   
  geom_point(data = ROI13[which(ROI13$kinv25=="4"),], size = 0.01, colour = "red")+
  geom_point(data = ROI13[which(ROI13$kinv25=="4"&ROI13$MI_CD11c>0.4&ROI13$MI_MHCcII>0.5),], size = 0.01, colour = "yellow")+

  
  #geom_point(data = ROI13[which(ROI13$MI_B220<0.5&ROI13$MI_B220>0.2),], size = 0.01, colour = "red")+
   # geom_point(data = ROI13[which(ROI13$annotation=="B cells"),], size = 0.5, colour = "yellow")+
    #geom_point(data = ROI13[which(ROI13$anncluster=="22B_Tumour"),], size = 0.1, colour = "red")+
 # geom_point(data = ROI13[which(ROI13$anncluster=="32_Tumour"),], size = 0.1, colour = "red")+
 #  geom_point(data = ROI13[which(ROI13$anncluster=="20_Tumour"),], size = 0.1, colour = "yellow")+
 #  geom_point(data = ROI13[which(ROI13$anncluster=="09A_Tumour"),], size = 0.1, colour = "green")+
  theme_classic() +
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        panel.background=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        strip.text = element_text(size = 8),
        strip.background = element_rect(),
        panel.spacing = unit(0, "mm"),
        plot.background = element_blank())+
  facet_wrap(~ROI_ID,nrow=1)


```






# plot annotation or anncluster to TSNE
```{r}
columns_to_add <- c("anncluster","annotation","cell_type","cell_ID")
celldata_subsample <- left_join(x = celldata_subsample, y = celldata[,columns_to_add], 
                     by = "cell_ID")
plot.tSNE(celldata_subsample, c("tSNE1", "tSNE2"), "annotation", savetSNE = F,
          title = "annotation", labelClusters = T)
plot.tSNE(celldata_subsample, c("tSNE1", "tSNE2"), "anncluster", savetSNE = F,
          title = "ancluster", labelClusters = T)
plot.tSNE(celldata_subsample, c("tSNE1", "tSNE2"), "cell_type", savetSNE = F,
          title = "cell_type", labelClusters = T)
```





# cross-checking in ImageJ

```{r clusteroverlay function}
# Get cluster overlay ----------------------------------------------------------
# Description : For each of the given 'levels' in 'factor', binary images are
#               created for every ROI where the locations of cells in this level
#               are plotted as a white dot with size 'size'.
# --- parameters ---
# celldata  --> [dataframe] a dataframe with mean intensity data by marker
# ROIdata   --> [dataframe] a dataframe with the filename of each ROI and its
#               height and width in pixels
# factor    --> [string] name of a column of 'dataframe' that acts as a factor
# levels    --> [vector] a vector with levels of factor; cells belonging to
#               one of these levels are included in the plot
# size      --> [numeric] a number representing the size of the dots
# << Output >>  Binary images for each ROI for each level in factor 
plot.clusteroverlay = function(celldata, ROIdata, factor, levels, size = 1){
  rootdir = create.resultsdir(path = OUTPUT_PATH, name = "ImageJ_Overlay")
  
  # Loop through ROIs
  for(i in 1:nrow(ROIdata)){
    # Create a directory for each ROI
    directory = file.path(rootdir, ROIdata[i,1])
    if (!dir.exists(directory)) dir.create(directory)
    
    for(k in 1:length(levels)){
      # Select the cells that belong to this cluster
      celldataTHR = celldata[which(celldata$filename == ROIdata$filename[i] &
                                     celldata[,factor] == levels[k]),
                             c(factor, "Location_Center_X", "Location_Center_Y")]
      
      xwidth = ROIdata$width[i]
      ylength = ROIdata$height[i]
      
      # Plot the cell locations
      p = ggplot(celldataTHR, aes(x=Location_Center_X, y=-Location_Center_Y)) + 
        geom_point(color = "white", size = size) +
        coord_cartesian(xlim = c(1, xwidth), ylim = c(-ylength, 0)) +
        theme_set(theme_cowplot()) + theme_void() +
        theme(plot.background=element_rect(fill = "grey"),
              panel.background = element_rect(fill = 'black')) +
        scale_x_continuous(expand=c(0,0)) +
        scale_y_continuous(expand=c(0,0))
      
      filename = paste0(factor, "_cluster_", levels[k], ".png")
      ggsave(plot = p, device = png, width = xwidth, height = ylength,
             units = "px", limitsize = FALSE, filename = filename,
             path = directory)
    }
  }
}
```

```{r}
plot.clusteroverlay(celldata = celldata, ROIdata = imagemetadata,
                    factor = "anncluster", levels = unique(celldata$anncluster))
plot.clusteroverlay(celldata = celldata, ROIdata = imagemetadata,
                    factor = "k25", levels = unique(celldata$k25))
```

# SAVE the celldata  .. 
```{r}
date<- format(Sys.Date(), "%y%m%d")
output_file = paste0(INPUT_PATH,"/", date, "_celldata.csv")
output_file
write.csv(celldata, file = output_file, row.names = F) 
write.csv(celldata,OUTPUT_PATH)

